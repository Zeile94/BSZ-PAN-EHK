<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>CWE ‚Äì Mitarbeiterchat</title>
<style>
:root {
  --bg: #121212;
  --surface: #1E1E1E;
  --surface-light: #2A2A2A;
  --text: #EAEAEA;
  --text-dim: #A8A8A8;
  --accent: #6264A7;
  --action: #6264A7;
  --bubble-user: var(--action);
  --bubble-bot: #2A2A2A;
  --border: #333;
  --desc-gray: #888;
  --teams-blue: #6264A7;
  --app-header-height: 70px;
  --time-text-color: #ffffff;
}
* {
  box-sizing: border-box;
}
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: manipulation;
}
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  display: flex;
  justify-content: center;
  align-items: stretch;
  font-size: 17px;
  overscroll-behavior: none;
}
.phone {
  width: 100%;
  max-width: 600px;
  height: 100dvh;
  min-height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}
.app-header {
  background: white;
  height: var(--app-header-height);
  padding: 0 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 600;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  color: #000000;
  user-select: none;
  flex-shrink: 0;
}
.app-header .ms-logo {
  position: absolute;
  left: 18px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.app-header .ms-logo img {
  max-width: 100%;
  max-height: 100%;
}
.app-header .logo {
  position: absolute;
  right: 18px;
  height: 40px;
}
.app-header .logo img {
  height: 40px;
  width: auto;
}
#chatList, #chatWindow {
  position: absolute;
  left: 0; right: 0;
  top: var(--app-header-height);
  bottom: 0;
  transition: transform 0.35s ease, opacity 0.35s ease;
  will-change: transform, opacity;
  background: var(--surface);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  -webkit-overflow-scrolling: touch;
}
#chatList.visible {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
  z-index: 40;
}
#chatList.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateX(-100%);
  z-index: 0;
}
#chatWindow.visible {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
  z-index: 50;
  display: flex;
}
#chatWindow.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateX(100%);
  z-index: 0;
  display: flex;
}
#chatList {
  background: var(--surface);
}
.chat-item {
  display: flex;
  align-items: center;
  padding: 12px;
  gap: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}
.chat-item:hover {
  background: #2b2b2b;
}
.chat-item img {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  object-fit: cover;
  background: var(--surface-light);
}
.chat-item .info .name {
  font-size: 16px;
  font-weight: 600;
}
.chat-item .info .role {
  font-size: 14px;
  color: var(--text-dim);
}
.desc {
  background: var(--surface);
  color: var(--desc-gray);
  font-size: 14px;
  line-height: 1.4;
  margin: 10px 14px;
  padding: 8px;
  border-radius: 8px;
  white-space: pre-wrap;
  word-break: break-word;
}
#chatWindow {
  flex-direction: column;
  overflow: hidden;
}
.chat-header {
  background: var(--surface-light);
  display: flex;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  position: relative;
  top: auto;
  z-index: 1;
  flex-shrink: 0;
}
.back-btn {
  font-size: 23px;
  cursor: pointer;
  color: var(--action);
  margin-right: 15px;
  user-select: none;
}
.chat-header img {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  background: var(--surface-light);
  margin-right: 15px;
}
.chat-header .name {
  font-size: 16px;
  font-weight: 600;
}
.messages {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 10px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) transparent;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
.msg {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 15px;
  line-height: 1.4;
  white-space: pre-wrap;
  word-break: break-word;
  color: var(--text);
}
.msg.user {
  background: var(--bubble-user);
  align-self: flex-end;
}
.msg.bot {
  background: var(--bubble-bot);
  border: 1px solid var(--border);
  align-self: flex-start;
}
.msg.document-container {
  display: flex;
  align-items: center;
  gap: 8px;
  background: transparent;
  border: none;
  padding: 0;
  max-width: 100%;
}
.msg.document-container .doc-icon {
  width: 40px;
  height: 40px;
  background: var(--bubble-user);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}
.msg.document-container .doc-name {
  background: var(--bubble-user);
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 14px;
  word-break: break-word;
  max-width: 200px;
  color: var(--text);
}
.msg.image-preview {
  background: transparent;
  border: none;
  padding: 0;
  max-width: 90%;
}
.msg.image-preview img {
  max-width: 100%;
  height: auto;
  border-radius: 14px;
  max-height: 400px;
}
#chatWindow.content-building .desc,
#chatWindow.content-building .messages {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
}
.composer {
  background: var(--surface);
  border: none;
  padding: 8px 0;
  display: flex;
  gap: 8px;
  align-items: flex-end;
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
  height: 65px;
  transform: translateY(-7.5px);
  transition: bottom 0.3s ease;
}
.composer-inner {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  width: 100%;
  transform: translateY(-5px);
  padding-left: 20px;
  padding-right: 20px;
}
.upload-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--action);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: filter 0.2s ease;
  font-size: 24px;
  color: var(--bg);
  user-select: none;
  padding: 0;
}
.upload-btn:hover,
.upload-btn:active,
.upload-btn:focus {
  filter: brightness(1.1);
  outline: none;
  box-shadow: none;
}
.upload-btn svg {
  width: 24px;
  height: 24px;
  fill: var(--bg);
}
#fileInput {
  display: none;
}
.composer textarea {
  flex: 1;
  min-height: 40px;
  max-height: 140px;
  background: var(--surface);
  color: var(--text);
  border: 0.7px solid white;
  border-radius: 10px;
  padding: 8px 20px 8px 20px;
  resize: none;
  overflow-y: hidden;
  font-family: inherit;
  font-size: 16px;
  line-height: 1.4;
  height: 40px;
  margin-bottom: 0;
  position: relative;
  bottom: 0;
  outline: none;
  box-shadow: none;
  max-width: none;
}
.send-icon {
  width: 40px;
  height: 40px;
  cursor: pointer;
  fill: var(--action);
  flex-shrink: 0;
  user-select: none;
  transition: filter 0.2s ease;
  margin-right: 0;
  vertical-align: bottom;
  outline: none;
}
.send-icon:hover,
.send-icon:active,
.send-icon:focus {
  filter: none;
  outline: none;
  box-shadow: none;
}
#passwordPrompt {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: var(--text);
  padding: 20px;
  text-align: center;
  gap: 10px;
  background: var(--surface);
}
#passwordPrompt label {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 10px;
}
#passwordPrompt input {
  padding: 10px 14px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface-light);
  color: var(--text);
  width: 250px;
  max-width: 90%;
  outline: none;
}
#passwordPrompt input:focus {
  border-color: var(--action);
}
#passwordPrompt button {
  padding: 8px 20px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: var(--action);
  color: white;
  cursor: pointer;
  user-select: none;
  transition: background-color 0.3s ease;
  font-weight: 500;
}
#passwordPrompt button:hover,
#passwordPrompt button:focus {
  background: #505090;
  outline: none;
  box-shadow: none;
}
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
.pop-bubble {
  display: inline-flex;
  max-width: 70%;
  gap: 6px;
  margin-bottom: 10px;
  align-items: center;
  white-space: nowrap;
}
.pop-dot {
  width: 10px;
  height: 10px;
  background-color: var(--teams-blue);
  border-radius: 50%;
  animation-name: bounce;
  animation-duration: 1.2s;
  animation-iteration-count: infinite;
  animation-timing-function: ease-in-out;
}
.pop-dot:nth-child(1) {
  animation-delay: 0s;
}
.pop-dot:nth-child(2) {
  animation-delay: 0.2s;
}
.pop-dot:nth-child(3) {
  animation-delay: 0.4s;
}
.hidden-element { 
  display: none !important; 
}
.timestamp {
  color: var(--time-text-color);
  font-size: 12px;
  margin-bottom: 8px;
  margin-top: 8px;
  font-weight: 400;
  user-select: none;
  text-align: center;
  opacity: 0.8;
}
</style>
</head>
<body>
<div class="phone">
  <div class="app-header">
    <div class="ms-logo"><img src="Teams.png" alt="Microsoft Teams Logo"></div>
    <div class="logo"><img src="00_Logo_CWE.png" alt="CWE Logo"></div>
  </div>

  <div id="chatList" class="visible">
    <div class="chat-item" data-person="tina">
      <img src="Tina.png" alt="Tina M√ºller" />
      <div class="info"><div class="name">Tina M√ºller</div><div class="role">Finanzabteilung</div></div>
    </div>
    <div class="chat-item" data-person="christian">
      <img src="Christian.png" alt="Christian Weber" />
      <div class="info"><div class="name">Christian Weber</div><div class="role">Marketing</div></div>
    </div>
    <div class="chat-item" data-person="hakan">
      <img src="Hakan.png" alt="Hakan Serdar" />
      <div class="info"><div class="name">Hakan Serdar</div><div class="role">Rechtsabteilung</div></div>
    </div>
    <div class="chat-item" data-person="sophie">
      <img src="Sophie.png" alt="Sophie Fischer" />
      <div class="info"><div class="name">Sophie Fischer</div><div class="role">Personalabteilung</div></div>
    </div>
    <div class="chat-item" data-person="sarah">
      <img src="Sarah.png" alt="Sarah Hosse" />
      <div class="info"><div class="name">Sarah Hosse</div><div class="role">Verkauf</div></div>
    </div>
    <div class="chat-item" data-person="timo">
      <img src="Timo.png" alt="Timo Jung" />
      <div class="info"><div class="name">Timo Jung</div><div class="role">Wirtschaftsanalyse</div></div>
    </div>
    <div class="chat-item" data-person="elke">
      <img src="Elke.png" alt="Elke Wagner" />
      <div class="info"><div class="name">Elke Wagner</div><div class="role">Empfang, Ausbildung & Schule</div></div>
    </div>
    <div class="chat-item" data-person="frank">
      <img src="Frank.png" alt="Frank Hiller" />
      <div class="info"><div class="name">Frank Hiller</div><div class="role">Gesch√§ftsf√ºhrung</div></div>
    </div>
  </div>

  <div id="chatWindow" class="hidden content-building" aria-hidden="true">
    <div class="chat-header">
      <span class="back-btn" id="backBtn" role="button" tabindex="0">‚Üê</span>
      <img id="chatAvatar" src="" alt="Avatar" />
      <div><div class="name" id="chatName"></div></div>
    </div>
    <div class="desc" id="chatDescription"></div>

    <div id="passwordPrompt" class="hidden-element" aria-live="polite" aria-atomic="true">
      <label for="passwordInput">Bitte Passwort eingeben, um den Chat zu √∂ffnen:</label>
      <input type="password" id="passwordInput" aria-label="Passwort eingeben" autocomplete="off" />
      <button id="passwordConfirmBtn" aria-label="Passwort best√§tigen">Best√§tigen</button>
      <div id="passwordError" style="color: #ff6666; margin-top: 8px; display: none;">Falsches Passwort. Bitte erneut versuchen.</div>
    </div>

    <div class="messages" id="messages" aria-live="polite"></div>
    <div class="composer" aria-label="Nachrichtenbereich">
      <div class="composer-inner">
        <button class="upload-btn" id="uploadBtn" aria-label="Datei hochladen" role="button" tabindex="0" type="button" >
          <svg xmlns="http://www.w3.org/2000/svg" fill="var(--bg)" viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" focusable="false">
            <path d="M4 4h16v16H4z" fill="none"/>
            <path d="M19 7v10H5V7h14m0-2H5c-1.1 0-2 .9-2 2v10a2 2 0 002 2h14a2 2 0 002-2V7c0-1.1-.9-2-2-2zM12 10.5l3 3h-2v4h-2v-4H9l3-3z"/>
          </svg>
        </button>
        <input type="file" id="fileInput" accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls" multiple="false" />
        <textarea id="input" placeholder="Nachricht eingeben..." rows="1" aria-label="Nachricht eingeben"></textarea>
        <svg id="send" class="send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-label="Senden" role="button" tabindex="0">
          <path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z"/>
        </svg>
      </div>
    </div>
  </div>
</div>

<script>
const profiles = {
  tina: { name: "Tina M√ºller", avatar: "Tina.png", desc: "Tina M√ºller arbeitet in der Finanzabteilung und ist dir bei allen Fragestellungen rund um Finanzen behilflich." },
  christian: { name: "Christian Weber", avatar: "Christian.png", desc: "Christian Weber arbeitet in der Marketingabteilung und ist dir bei allen Fragestellungen rund um Marketing behilflich." },
  hakan: { name: "Hakan Serdar", avatar: "Hakan.png", desc: "Hakan Serdar arbeitet in der Rechtsabteilung und ist dir bei allen rechtlichen Fragestellungen behilflich." },
  sophie: { name: "Sophie Fischer", avatar: "Sophie.png", desc: "Sophie Fischer arbeitet in der Personalabteilung und ist dir bei allen Fragestellungen rund um Personal behilflich." },
  sarah: { name: "Sarah Hosse", avatar: "Sarah.png", desc: "Sarah Hosse arbeitet im Verkauf und ist dir bei allen Fragestellungen rund um den Verkauf behilflich." },
  timo: { name: "Timo Jung", avatar: "Timo.png", desc: "Timo Jung arbeitet als Analyst bei der CWE und ist dir bei allen volkswirtschaftlichen Fragestellungen behilflich." },
  elke: { name: "Elke Wagner", avatar: "Elke.png", desc: "Elke Wagner arbeitet am Empfang und ist dir bei allen Fragestellungen behilflich, bei denen dir sonst niemand helfen kann. Au√üerdem ist sie deine Ausbildungskoordinatorin und hilft dir auch bei Fragen rund um die Berufsschule weiter." },
  frank: { name: "Frank Hiller", avatar: "Frank.png", desc: "Frank Hiller ist Gesch√§ftsf√ºhrer der CenterWarenhaus GmbH in Eggenfelden. Er ist Ansprechpartner f√ºr Lehrkr√§fte." }
};

const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const messagesDiv = document.getElementById("messages");
const chatDescription = document.getElementById("chatDescription");
const chatName = document.getElementById("chatName");
const chatAvatar = document.getElementById("chatAvatar");
const backBtn = document.getElementById("backBtn");
const input = document.getElementById("input");
const send = document.getElementById("send");
const passwordPrompt = document.getElementById("passwordPrompt");
const passwordInput = document.getElementById("passwordInput");
const passwordConfirmBtn = document.getElementById("passwordConfirmBtn");
const passwordError = document.getElementById("passwordError");
const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("fileInput");

let currentPerson = null;
let frankAccessGranted = false;
let popBubbleElement = null;
let currentUploadedFile = null;
let lastTimestamp = null;

const history = {
  tina: [],
  christian: [],
  hakan: [],
  sophie: [],
  sarah: [],
  timo: [],
  elke: [],
  frank: []
};

function checkFrankAccess() {
  const access = localStorage.getItem('frankAccessGranted');
  return access === 'true';
}

function setFrankAccess() {
  localStorage.setItem('frankAccessGranted', 'true');
  frankAccessGranted = true;
}

// √ÑNDERUNG 1: Zeitstempel-Formatierungsfunktion
function formatTimestamp(date) {
  const now = new Date();
  const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const diffTime = today - msgDate;
  const diffDays = diffTime / (1000 * 60 * 60 * 24);

  if (diffDays === 0) return `Heute, ${timeStr}`;
  if (diffDays === 1) return `Gestern, ${timeStr}`;
  if (diffDays > 1 && diffDays <= 6) {
    const weekDay = date.toLocaleDateString('de-DE', { weekday: 'long' });
    return `${weekDay.charAt(0).toUpperCase() + weekDay.slice(1)}, ${timeStr}`;
  }
  const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: 'long' });
  return `${dateStr}, ${timeStr}`;
}

// √ÑNDERUNG 2: Zeitstempel-Anzeige √ºberpr√ºfen und hinzuf√ºgen
function shouldShowTimestamp(currentTime) {
  if (!lastTimestamp) return true;
  
  const lastDate = new Date(lastTimestamp.getFullYear(), lastTimestamp.getMonth(), lastTimestamp.getDate());
  const currentDate = new Date(currentTime.getFullYear(), currentTime.getMonth(), currentTime.getDate());
  
  if (lastDate.getTime() !== currentDate.getTime()) return true;
  if (currentTime - lastTimestamp > 5 * 60 * 1000) return true;
  
  return false;
}

function hideChatContent() {
  chatWindow.classList.add('content-building');
}

function showChatContent() {
  chatWindow.classList.remove('content-building');
}

function scrollToBottom({ smooth = true } = {}) {
  const behavior = smooth ? 'smooth' : 'auto';
  requestAnimationFrame(() => {
    try {
      messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior });
    } catch (e) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  });
}

// √ÑNDERUNG 3: addMessage erweitert mit Zeitstempel
function addMessage(text, who, { scroll = true, timestamp = new Date() } = {}) {
  if (shouldShowTimestamp(timestamp)) {
    const timestampDiv = document.createElement("div");
    timestampDiv.className = "timestamp";
    timestampDiv.textContent = formatTimestamp(timestamp);
    messagesDiv.appendChild(timestampDiv);
    lastTimestamp = timestamp;
  }

  const div = document.createElement("div");
  div.className = "msg " + who;
  div.textContent = text;
  messagesDiv.appendChild(div);
  if (scroll) scrollToBottom();
  return div;
}

function addDocumentMessage(fileName, who) {
  const container = document.createElement("div");
  container.className = "msg document-container " + who;
  
  const iconDiv = document.createElement("div");
  iconDiv.className = "doc-icon";
  iconDiv.textContent = "üìÑ";
  
  const nameDiv = document.createElement("div");
  nameDiv.className = "doc-name";
  nameDiv.textContent = fileName;
  
  container.appendChild(iconDiv);
  container.appendChild(nameDiv);
  messagesDiv.appendChild(container);
  scrollToBottom();
  return container;
}

function addImageMessage(imageSrc, who) {
  const container = document.createElement("div");
  container.className = "msg image-preview " + who;
  
  const img = document.createElement("img");
  img.src = imageSrc;
  img.alt = "Hochgeladenes Bild";
  
  container.appendChild(img);
  messagesDiv.appendChild(container);
  scrollToBottom();
  return container;
}

function moveChatItemToTop(person) {
  const item = document.querySelector(`.chat-item[data-person="${person}"]`);
  if (item) {
    chatList.removeChild(item);
    chatList.insertBefore(item, chatList.firstChild);
  }
}

function openChat(person) {
  currentPerson = person;
  currentUploadedFile = null;
  lastTimestamp = null;

  if (person === 'frank') {
    frankAccessGranted = checkFrankAccess();
  } else {
    frankAccessGranted = false;
  }

  hideChatContent();

  chatWindow.classList.add('hidden');
  chatWindow.classList.remove('visible');
  chatWindow.setAttribute('aria-hidden', 'true');

  chatList.classList.remove('hidden');
  chatList.classList.add('visible');

  chatName.textContent = profiles[person].name;
  chatAvatar.src = profiles[person].avatar;

  if (person === 'frank') {
    chatDescription.textContent = profiles[person].desc;
    chatDescription.style.display = "block";
    if (!frankAccessGranted) {
      passwordPrompt.classList.remove('hidden-element');
      messagesDiv.style.display = 'none';
      input.parentElement.parentElement.style.display = 'none';
    } else {
      passwordPrompt.classList.add('hidden-element');
      messagesDiv.style.display = 'flex';
      input.parentElement.parentElement.style.display = 'flex';
      if (history[person].length === 0) {
        chatDescription.style.display = "block";
      } else {
        chatDescription.style.display = "none";
      }
    }
  } else {
    passwordPrompt.classList.add('hidden-element');
    messagesDiv.style.display = 'flex';
    input.parentElement.parentElement.style.display = 'flex';
    if (history[person].length === 0) {
      chatDescription.textContent = profiles[person].desc;
      chatDescription.style.display = "block";
    } else {
      chatDescription.style.display = "none";
    }
  }

  messagesDiv.innerHTML = "";
  const prevScrollBehavior = messagesDiv.style.scrollBehavior;
  messagesDiv.style.scrollBehavior = 'auto';

  if (!(person === 'frank' && !frankAccessGranted)) {
    history[person].forEach(msg => {
      if (msg.type === 'text') {
        const div = document.createElement("div");
        div.className = "msg " + msg.who;
        div.textContent = msg.text;
        messagesDiv.appendChild(div);
      } else if (msg.type === 'document') {
        const container = document.createElement("div");
        container.className = "msg document-container " + msg.who;
        const iconDiv = document.createElement("div");
        iconDiv.className = "doc-icon";
        iconDiv.textContent = "üìÑ";
        const nameDiv = document.createElement("div");
        nameDiv.className = "doc-name";
        nameDiv.textContent = msg.fileName;
        container.appendChild(iconDiv);
        container.appendChild(nameDiv);
        messagesDiv.appendChild(container);
      } else if (msg.type === 'image') {
        const container = document.createElement("div");
        container.className = "msg image-preview " + msg.who;
        const img = document.createElement("img");
        img.src = msg.imageSrc;
        img.alt = "Bild";
        container.appendChild(img);
        messagesDiv.appendChild(container);
      }
    });
  }

  scrollToBottom({ smooth: false });
  messagesDiv.style.scrollBehavior = prevScrollBehavior || '';

  input.value = "";
  adjustTextareaHeight();
  passwordInput.value = "";
  passwordError.style.display = "none";

  requestAnimationFrame(() => {
    void chatWindow.offsetHeight;

    chatWindow.classList.remove('hidden');
    chatWindow.classList.add('visible');
    chatWindow.setAttribute('aria-hidden', 'false');

    chatList.classList.remove('visible');
    chatList.classList.add('hidden');

    const onShown = (e) => {
      showChatContent();
    };
    chatWindow.addEventListener('transitionend', onShown, { once: true });
  });
}

function backToChatList() {
  try {
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
    if (input && typeof input.blur === 'function') input.blur();
    if (passwordInput && typeof passwordInput.blur === 'function') passwordInput.blur();
  } catch (e) {}

  hideChatContent();

  chatList.classList.remove('hidden');
  chatList.classList.add('visible');

  chatWindow.classList.remove('visible');
  chatWindow.classList.add('hidden');
  chatWindow.setAttribute('aria-hidden', 'true');

  currentPerson = null;
  currentUploadedFile = null;
  frankAccessGranted = false;
  lastTimestamp = null;
}

function adjustTextareaHeight() {
  input.style.height = "auto";
  const minHeight = 40;
  const maxHeight = 140;
  const scrollHeight = input.scrollHeight;
  if (scrollHeight < minHeight) {
    input.style.height = minHeight + "px";
    input.style.overflowY = "hidden";
  } else if (scrollHeight > maxHeight) {
    input.style.height = maxHeight + "px";
    input.style.overflowY = "scroll";
  } else {
    input.style.height = scrollHeight + "px";
    input.style.overflowY = "hidden";
  }
  let growAmount = scrollHeight - 40;
  if (growAmount < 0) growAmount = 0;
  input.style.marginTop = `-${growAmount}px`;
}

function isTouchDevice() {
  return (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
}

document.querySelectorAll(".chat-item").forEach(item => {
  item.addEventListener("click", () => openChat(item.dataset.person));
});

function showPopBubble() {
  if (popBubbleElement) return;
  popBubbleElement = document.createElement("div");
  popBubbleElement.className = "pop-bubble";
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement("div");
    dot.className = "pop-dot";
    dot.style.animationDelay = (i * 0.2) + "s";
    popBubbleElement.appendChild(dot);
  }
  messagesDiv.appendChild(popBubbleElement);
  scrollToBottom();
}

function removePopBubble() {
  if (popBubbleElement) {
    popBubbleElement.remove();
    popBubbleElement = null;
  }
}

function buildMessages() {
  return history[currentPerson].map(m => {
    if (m.type === 'text') {
      return { role: m.who === "user" ? "user" : "assistant", content: m.text };
    } else if (m.type === 'document') {
      return { 
        role: m.who === "user" ? "user" : "assistant", 
        content: `[Dokument hochgeladen: ${m.fileName}]\n${m.base64}` 
      };
    } else if (m.type === 'image') {
      return { 
        role: m.who === "user" ? "user" : "assistant", 
        content: [
          { type: "text", text: "[Bild hochgeladen]" },
          { type: "image_url", image_url: { url: m.imageSrc } }
        ]
      };
    }
  });
}

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf', 'text/plain', 
                        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
  
  if (!allowedTypes.includes(file.type)) {
    alert('Dateityp nicht unterst√ºtzt. Bitte laden Sie ein Bild oder Dokument hoch.');
    return;
  }

  const reader = new FileReader();
  
  reader.onload = function(e) {
    currentUploadedFile = {
      name: file.name,
      type: file.type,
      data: e.target.result
    };

    if (file.type.startsWith('image/')) {
      addImageMessage(e.target.result, 'user');
      history[currentPerson].push({
        type: 'image',
        who: 'user',
        imageSrc: e.target.result
      });
    } else {
      addDocumentMessage(file.name, 'user');
      history[currentPerson].push({
        type: 'document',
        who: 'user',
        fileName: file.name,
        base64: e.target.result
      });
    }

    if (chatDescription.style.display !== "none") {
      chatDescription.style.display = "none";
    }
  };

  if (file.type.startsWith('image/')) {
    reader.readAsDataURL(file);
  } else {
    reader.readAsDataURL(file);
  }

  fileInput.value = '';
}

// √ÑNDERUNG 4: Robustes Fehlerhandling beim Senden von Nachrichten
async function sendMessage() {
  const text = input.value.trim();
  
  if (!text && !currentUploadedFile && !currentPerson) return;

  if (currentPerson === 'frank' && !frankAccessGranted) {
    addMessage("Zugang verweigert. Bitte Passwort eingeben.", "bot");
    input.value = "";
    adjustTextareaHeight();
    return;
  }

  if (text) {
    addMessage(text, "user");
    history[currentPerson].push({ type: 'text', text, who: "user" });
  }

  showPopBubble();
  input.value = "";
  adjustTextareaHeight();
  currentUploadedFile = null;

  if (chatDescription.style.display !== "none") {
    chatDescription.style.display = "none";
  }

  try {
    const messageBody = {
      person: currentPerson,
      messages: buildMessages()
    };

    const resp = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(messageBody)
    });
    
    // √ÑNDERUNG 5: Robuste Verarbeitung der Antwort
    if (!resp.ok) {
      removePopBubble();
      addMessage("Momentan habe ich technische Schwierigkeiten. Versuch es gerne gleich nochmal!", "bot");
      history[currentPerson].push({ type: 'text', text: "Momentan habe ich technische Schwierigkeiten. Versuch es gerne gleich nochmal!", who: "bot" });
      moveChatItemToTop(currentPerson);
      return;
    }
    
    const data = await resp.json();
    
    // √ÑNDERUNG 6: Sichere Extraktion der Antwort mit Fallback
    let answer = "Momentan habe ich technische Schwierigkeiten. Versuch es gerne gleich nochmal!";
    if (data && data.message && data.message.content) {
      answer = data.message.content;
    }
    
    removePopBubble();
    addMessage(answer, "bot");
    history[currentPerson].push({ type: 'text', text: answer, who: "bot" });
    moveChatItemToTop(currentPerson);

  } catch (error) {
    console.error("Fehler beim Senden:", error);
    removePopBubble();
    // √ÑNDERUNG 7: Freundliche Fehlermeldung statt Fehler
    addMessage("Momentan habe ich technische Schwierigkeiten. Versuch es gerne gleich nochmal!", "bot");
    history[currentPerson].push({ type: 'text', text: "Momentan habe ich technische Schwierigkeiten. Versuch es gerne gleich nochmal!", who: "bot" });
    moveChatItemToTop(currentPerson);
  }
}

input.addEventListener("keydown", e => {
  if (isTouchDevice()) return;
  if (e.key === "Enter") {
    if (e.shiftKey) return;
    e.preventDefault();
    sendMessage();
  }
});

input.addEventListener("input", () => adjustTextareaHeight());
send.addEventListener("click", sendMessage);

uploadBtn.addEventListener("click", () => {
  fileInput.click();
});

uploadBtn.addEventListener("keydown", (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    fileInput.click();
  }
});

fileInput.addEventListener("change", handleFileUpload);

backBtn.addEventListener("click", () => {
  backToChatList();
});

backBtn.addEventListener("keydown", (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    backToChatList();
  }
});

passwordConfirmBtn.addEventListener("click", () => {
  const enteredPassword = passwordInput.value;
  if (enteredPassword === "84307") {
    setFrankAccess();

    passwordPrompt.classList.add('hidden-element');
    messagesDiv.style.display = 'flex';
    input.parentElement.parentElement.style.display = 'flex';
    chatDescription.style.display = history['frank'].length === 0 ? "block" : "none";

    messagesDiv.innerHTML = "";
    history['frank'].forEach(msg => {
      if (msg.type === 'text') {
        const div = document.createElement("div");
        div.className = "msg " + msg.who;
        div.textContent = msg.text;
        messagesDiv.appendChild(div);
      } else if (msg.type === 'document') {
        const container = document.createElement("div");
        container.className = "msg document-container " + msg.who;
        const iconDiv = document.createElement("div");
        iconDiv.className = "doc-icon";
        iconDiv.textContent = "üìÑ";
        const nameDiv = document.createElement("div");
        nameDiv.className = "doc-name";
        nameDiv.textContent = msg.fileName;
        container.appendChild(iconDiv);
        container.appendChild(nameDiv);
        messagesDiv.appendChild(container);
      } else if (msg.type === 'image') {
        const container = document.createElement("div");
        container.className = "msg image-preview " + msg.who;
        const img = document.createElement("img");
        img.src = msg.imageSrc;
        img.alt = "Bild";
        container.appendChild(img);
        messagesDiv.appendChild(container);
      }
    });
    
    scrollToBottom({ smooth: false });
    passwordInput.value = "";
    passwordError.style.display = "none";
    input.focus();
  } else {
    passwordError.style.display = "block";
    passwordInput.value = "";
    passwordInput.focus();
  }
});

passwordInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    passwordConfirmBtn.click();
  }
});

let touchStartX = null;
let touchStartY = null;
let touchMoveX = null;
let touchMoveY = null;
let dragging = false;

chatWindow.addEventListener('touchstart', function(e) {
  if (e.touches.length === 1) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchMoveX = null;
    touchMoveY = null;
    dragging = false;
  }
}, {passive: true});

chatWindow.addEventListener('touchmove', function(e) {
  if (e.touches.length === 1 && touchStartX !== null && touchStartY !== null) {
    touchMoveX = e.touches[0].clientX;
    touchMoveY = e.touches[0].clientY;
    const deltaX = touchMoveX - touchStartX;
    const deltaY = touchMoveY - touchStartY;
    const absDeltaX = Math.abs(deltaX);
    const absDeltaY = Math.abs(deltaY);
    const swipeStartedLeftArea = touchStartX < 100;

    if (swipeStartedLeftArea && deltaX > 0 && absDeltaX > absDeltaY) {
      dragging = true;

      hideChatContent();

      e.preventDefault && e.preventDefault();
      chatWindow.style.transition = 'none';
      chatList.style.transition = 'none';

      chatList.classList.remove('hidden');
      chatList.classList.add('visible');
      chatList.style.pointerEvents = 'auto';

      const translateX = Math.min(window.innerWidth, deltaX);
      chatWindow.style.transform = `translateX(${translateX}px)`;

      const pct = Math.min(1, deltaX / window.innerWidth);
      const listTranslate = -100 + (pct * 100);
      chatList.style.transform = `translateX(${listTranslate}%)`;
    }
  }
}, {passive: false});

chatWindow.addEventListener('touchend', function(e) {
  if (touchStartX !== null && touchMoveX !== null && touchStartY !== null && touchMoveY !== null) {
    const deltaX = touchMoveX - touchStartX;
    const deltaY = touchMoveY - touchStartY;
    const absDeltaX = Math.abs(deltaX);
    const absDeltaY = Math.abs(deltaY);
    const swipeStartedLeftArea = touchStartX < 100;

    if (dragging && swipeStartedLeftArea && deltaX > 50 && absDeltaX > absDeltaY) {
      try {
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
          document.activeElement.blur();
        }
        if (input && typeof input.blur === 'function') input.blur();
        if (passwordInput && typeof passwordInput.blur === 'function') passwordInput.blur();
      } catch (e) {}

      hideChatContent();

      chatWindow.style.transition = '';
      chatList.style.transition = '';
      chatWindow.style.transform = `translateX(${window.innerWidth}px)`;
      chatList.style.transform = `translateX(0%)`;

      const cleanup = () => {
        chatWindow.style.transition = '';
        chatWindow.style.transform = '';
        chatList.style.transform = '';
        chatList.style.pointerEvents = '';
        chatWindow.classList.remove('visible');
        chatWindow.classList.add('hidden');
        chatWindow.setAttribute('aria-hidden', 'true');
        chatWindow.removeEventListener('transitionend', cleanup);
      };
      chatWindow.addEventListener('transitionend', cleanup);
      chatList.classList.remove('hidden');
      chatList.classList.add('visible');
      currentPerson = null;
      lastTimestamp = null;
    } else {
      chatWindow.style.transition = '';
      chatList.style.transition = '';
      chatWindow.style.transform = '';
      chatList.style.transform = '';
      if (!chatWindow.classList.contains('hidden')) {
        chatWindow.classList.add('visible');
        chatWindow.classList.remove('hidden');
      }
      chatList.classList.remove('visible');
      chatList.classList.add('hidden');
      chatList.style.pointerEvents = '';

      showChatContent();
    }
  }

  touchStartX = null;
  touchStartY = null;
  touchMoveX = null;
  touchMoveY = null;
  dragging = false;
}, {passive: true});

messagesDiv.addEventListener('click', () => {
  if (document.activeElement === input) {
    input.blur();
  }
});

(function() {
  let originalWindowInnerHeight = window.innerHeight;
  window.addEventListener('resize', () => {
    const composer = document.querySelector('.composer');
    if(!composer) return;
    const keyboardOpen = window.innerHeight < originalWindowInnerHeight * 0.9;
    if(keyboardOpen) {
      composer.style.position = 'absolute';
      composer.style.bottom = 'env(keyboard-inset-bottom, 0px)';
      composer.style.width = '100%';
      composer.style.zIndex = '20';
    } else {
      composer.style.position = 'sticky';
      composer.style.bottom = '0';
      composer.style.width = '100%';
      composer.style.zIndex = '';
    }
  });
})();

send.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    sendMessage();
  }
});
</script>
</body>
</html>
