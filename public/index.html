<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CWE – Mitarbeiterchat</title>

  <style>
    :root {
      --bg: #121212;
      --surface: #1E1E1E;
      --surface-light: #2A2A2A;
      --text: #EAEAEA;
      --text-dim: #A8A8A8;
      --accent: #4C59F0;
      --bubble-user: #2F49B5;
      --bubble-bot: #2A2A2A;
      --border: #333;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px 0;
    }

    /* iPhone Frame, Höhe um ca. 1/4 reduziert (von 844px auf ca. 633px) */
    .phone {
      width: 390px;
      height: 633px;
      background: var(--surface);
      border-radius: 35px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 2px solid #000;
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
    }

    /* HEADER - nun weiß, deutlich größer */
    .header {
      background: var(--surface-light);
      padding: 18px 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      position: relative;
      color: white;
    }

    /* CWE Logo rechts größer */
    .header .logo {
      position: absolute;
      right: 18px;
      height: 40px;
      width: auto;
    }
    .header .logo img {
      height: 40px;
      width: auto;
      display: block;
    }

    /* KONTAKTLISTE */
    #chatList {
      display: block;
      flex: 1;
      overflow-y: auto;
      background: var(--surface);
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }

    .chat-item:hover {
      background: #2b2b2b;
    }

    .chat-item img {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--surface-light);
    }

    .chat-item .info .name {
      font-size: 15px;
      font-weight: 600;
    }
    .chat-item .info .role {
      font-size: 13px;
      color: var(--text-dim);
    }

    /* CHATFENSTER */
    #chatWindow {
      display: none;
      flex: 1;
      flex-direction: column;
      background: var(--surface);
    }

    .chat-header {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      background: var(--surface-light);
      border-bottom: 1px solid var(--border);
      gap: 12px;
      position: relative;
    }

    /* Zurück-Button */
    .back-btn {
      position: absolute;
      left: 14px;
      font-size: 22px;
      cursor: pointer;
      color: var(--accent);
      user-select: none;
    }

    .chat-header img {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      margin-left: 30px;
      background: var(--surface-light);
    }

    .chat-header .name {
      font-size: 15px;
      font-weight: 600;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .msg.user {
      background: var(--bubble-user);
      align-self: flex-end;
    }

    .msg.bot {
      background: var(--bubble-bot);
      border: 1px solid var(--border);
      align-self: flex-start;
    }

    /* Composer */
    .composer {
      display: flex;
      padding: 8px 10px;
      background: var(--surface-light);
      border-top: 1px solid var(--border);
      gap: 8px;
      align-items: flex-end;
    }

    /* Textarea dynamisch, Button fix */
    .composer textarea {
      flex: 1;
      min-height: 40px;
      max-height: 140px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      resize: none;
      overflow-y: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 15px;
      line-height: 1.4;
    }

    .composer button {
      background: var(--accent);
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      user-select: none;
      flex-shrink: 0;
      height: 40px; /* feste Höhe */
    }
  </style>
</head>
<body>

<div class="phone">

  <!-- HEADER -->
  <div class="header">
    Chats
    <div class="logo">
      <img src="00_Logo_CWE.png" alt="CWE Logo">
    </div>
  </div>

  <!-- CHAT LIST -->
  <div id="chatList">

    <div class="chat-item" data-person="tina">
      <img src="DATA_URI_TINA" alt="Tina">
      <div class="info">
        <div class="name">Tina</div>
        <div class="role">Finanzabteilung</div>
      </div>
    </div>

    <div class="chat-item" data-person="christian">
      <img src="DATA_URI_CHRISTIAN" alt="Christian">
      <div class="info">
        <div class="name">Christian</div>
        <div class="role">Marketing</div>
      </div>
    </div>

    <div class="chat-item" data-person="hakan">
      <img src="DATA_URI_HAKAN" alt="Hakan">
      <div class="info">
        <div class="name">Hakan</div>
        <div class="role">Rechtsabteilung</div>
      </div>
    </div>

    <div class="chat-item" data-person="sophie">
      <img src="DATA_URI_SOPHIE" alt="Sophie">
      <div class="info">
        <div class="name">Sophie</div>
        <div class="role">Personalabteilung</div>
      </div>
    </div>

    <div class="chat-item" data-person="elke">
      <img src="DATA_URI_ELKE" alt="Elke">
      <div class="info">
        <div class="name">Elke</div>
        <div class="role">Backoffice</div>
      </div>
    </div>

    <div class="chat-item" data-person="sarah">
      <img src="DATA_URI_SARAH" alt="Sarah">
      <div class="info">
        <div class="name">Sarah</div>
        <div class="role">Verkauf</div>
      </div>
    </div>

  </div>

  <!-- CHAT WINDOW -->
  <div id="chatWindow">

    <div class="chat-header">
      <span class="back-btn" id="backBtn">←</span>
      <img id="chatAvatar" src="" alt="Avatar">
      <div>
        <div class="name" id="chatName"></div>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <textarea id="input" placeholder="Nachricht eingeben..." rows="1"></textarea>
      <button id="send">Senden</button>
    </div>
  </div>

</div>

<script>
  const chatList = document.getElementById("chatList");
  const chatWindow = document.getElementById("chatWindow");
  const messagesDiv = document.getElementById("messages");
  const backBtn = document.getElementById("backBtn");
  const input = document.getElementById("input");
  const send = document.getElementById("send");
  const chatName = document.getElementById("chatName");
  const chatAvatar = document.getElementById("chatAvatar");

  let currentPerson = null;

  const profiles = {
    tina: { 
      name: "Tina", 
      avatar: "DATA_URI_TINA",
      system: `Du bist Tina aus der Finanzabteilung der CenterWarenhaus GmbH Eggenfelden (CWE). 
Du bist eine junge Frau, gerade ausgelernt, liebst alles rund um Buchführung und verstehst auch komplexe Zusammenhänge, kannst diese einfach erklären. 
Wenn jemand Fragen zu anderen Bereichen hat, verweise höflich auf den jeweiligen Fachkollegen. 
Bei schwierigen Themen weise darauf hin, dass Herr Zeilberger (h.zeilberger@bszpfarrkirchen.de) gerne weiterhilft.`
    },
    christian: {
      name: "Christian",
      avatar: "DATA_URI_CHRISTIAN",
      system: `Du bist Christian aus dem Marketing der CenterWarenhaus GmbH Eggenfelden (CWE).
Du bist ein junger Mann, seit ca. 5 Jahren dabei, der lässige Marketing-Typ mit vielen kreativen Ideen.
Bleibe im Marketing-Fachgebiet. Für andere Fragen verweise auf passende Kollegen.
Bei Unsicherheiten verweise freundlich auf Herrn Zeilberger (h.zeilberger@bszpfarrkirchen.de).`
    },
    hakan: {
      name: "Hakan",
      avatar: "DATA_URI_HAKAN",
      system: `Du bist Hakan, zuständig für Recht bei CenterWarenhaus GmbH Eggenfelden (CWE).
Juristisch sehr versiert, kennst Fachbegriffe, erklärst sie aber verständlich.
Bleibe bei juristischen Fragen, verweise auf Kollegen bei anderen Themen.
Bei komplexen Sachverhalten verweise auf Herrn Zeilberger (h.zeilberger@bszpfarrkirchen.de).`
    },
    sophie: {
      name: "Sophie",
      avatar: "DATA_URI_SOPHIE",
      system: `Du bist Sophie aus der Personalabteilung der CenterWarenhaus GmbH Eggenfelden (CWE).
Etwa 38 Jahre alt, Mutter von zwei kleinen Mädchen, sehr erfahren im Personalwesen.
Antworte praxisnah, verweise bei anderen Themen auf Kollegen.
Schwere Fragen leitest du an Herrn Zeilberger (h.zeilberger@bszpfarrkirchen.de) weiter.`
    },
    elke: {
      name: "Elke",
      avatar: "DATA_URI_ELKE",
      system: `Du bist Elke aus dem Backoffice der CenterWarenhaus GmbH Eggenfelden (CWE).
Etwa 62 Jahre alt, graues Haar, die liebevolle Mutti im Büro.
Kümmert sich um Anliegen, für die sonst niemand zuständig ist.
Weise bei fachfremden Fragen auf andere Chatbots hin.
Bei schwierigen Fragen verweise auf Herrn Zeilberger (h.zeilberger@bszpfarrkirchen.de).`
    },
    sarah: {
      name: "Sarah",
      avatar: "DATA_URI_SARAH",
      system: `Du bist Sarah aus dem Verkauf der CenterWarenhaus GmbH Eggenfelden (CWE).
Mitte 40, eher streng, legt Wert auf richtige Warenpräsentation und gutes Verhalten der Mitarbeitenden.
Dir ist eine sehr gute Kundenberatung wichtig.
Bei Fragen zu anderen Fachbereichen verweist du auf die Kollegen.
Schwierige Themen leitest du an Herrn Zeilberger (h.zeilberger@bszpfarrkirchen.de) weiter.`
    },
  };

  const history = {
    tina: [],
    christian: [],
    hakan: [],
    sophie: [],
    elke: [],
    sarah: []
  };

  document.querySelectorAll(".chat-item").forEach(item => {
    item.addEventListener("click", () => {
      currentPerson = item.dataset.person;

      chatList.style.display = "none";
      chatWindow.style.display = "flex";

      chatName.textContent = profiles[currentPerson].name;
      chatAvatar.src = profiles[currentPerson].avatar;

      messagesDiv.innerHTML = "";

      history[currentPerson].forEach(msg => {
        addMessage(msg.text, msg.who);
      });

      input.value = "";
      input.style.height = 'auto'; // reset height
    });
  });

  backBtn.addEventListener("click", () => {
    chatWindow.style.display = "none";
    chatList.style.display = "block";
  });

  function addMessage(text, who) {
    const div = document.createElement("div");
    div.className = "msg " + who;
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  input.addEventListener('input', () => {
    input.style.height = 'auto';
    input.style.height = (input.scrollHeight) + 'px';
  });

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    history[currentPerson].push({ text, who: "user" });

    const systemMessage = profiles[currentPerson].system;

    const lastUserMsg = history[currentPerson]
      .filter(m => m.who === "user")
      .slice(-2)
      .map(m => m.text)
      .join("\n");

    const resp = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        person: currentPerson,
        messages: [
          { role: "system", content: systemMessage + "\nBeziehe dich bei Anschlussfragen auf die vorige Frage:\n" + lastUserMsg },
          { role: "user", content: text }
        ]
      })
    });

    const data = await resp.json();
    const answer = data.message?.content ?? "Fehler.";

    addMessage(answer, "bot");
    history[currentPerson].push({ text: answer, who: "bot" });

    input.value = "";
    input.style.height = 'auto';
  }

  send.addEventListener("click", sendMessage);
  input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>

</body>
</html>
