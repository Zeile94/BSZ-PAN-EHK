<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />

<!-- Verhindert Scrollen, Verschieben, Zoomen -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

<title>CWE ‚Äì Mitarbeiterchat</title>

<style>
:root {
    --bg: #121212;
    --surface: #1E1E1E;
    --surface-light: #2A2A2A;
    --text: #EAEAEA;
    --text-dim: #A8A8A8;
    --accent: #6264A7;
    --bubble-user: #2F49B5;
    --bubble-bot: #2A2A2A;
    --border: #333;
    --desc-gray: #888;
}

* { box-sizing: border-box; }

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    position: fixed;
    top: 0;
    left: 0;
    touch-action: none;
}

body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: flex;
    justify-content: center;
    align-items: stretch;
}

.phone {
    width: 100%;
    max-width: 600px;
    height: 100vh;
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

/* Header */
.header {
    background: white;
    height: 70px;
    padding: 0 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    z-index: 10;
    color: #000000;
    flex-shrink: 0;
}
.header .ms-logo {
    position: absolute;
    left: 18px;
    width: 32px;
    height: 32px;
}
.header .logo {
    position: absolute;
    right: 18px;
    height: 40px;
}

/* === Slide Animation Container === */
#chatWindow {
    position: absolute;
    top: 0;
    left: 100%;
    width: 100%;
    height: 100%;
    background: var(--surface);
    display: flex;
    flex-direction: column;
    transition: left 0.35s ease;
}
#chatWindow.visible {
    left: 0%;
}

/* Chatliste */
#chatList {
    flex: 1;
    overflow-y: auto;
    background: var(--surface);
}

.chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
}
.chat-item:hover {
    background: #2b2b2b;
}
.chat-item img {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
}

/* Chat Header */
.chat-header {
    background: var(--surface-light);
    display: flex;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}
.back-btn {
    font-size: 22px;
    cursor: pointer;
    color: var(--accent);
    margin-right: 15px;
}
.chat-header img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    margin-right: 15px;
}
.chat-header .name {
    font-size: 15px;
    font-weight: 600;
}

/* Beschreibung */
.desc {
    background: var(--surface);
    color: var(--desc-gray);
    font-size: 13px;
    margin: 10px 14px;
    padding: 8px;
    border-radius: 8px;
}

/* Nachrichten */
.messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Bubbles */
.msg {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap;
}
.msg.user {
    background: var(--bubble-user);
    align-self: flex-end;
}
.msg.bot {
    background: var(--bubble-bot);
    border: 1px solid var(--border);
    align-self: flex-start;
}

/* Typing Indicator */
.typing {
    width: 60px;
    height: 30px;
    background: var(--bubble-bot);
    border-radius: 20px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 0 10px;
}
.typing div {
    width: 6px;
    height: 6px;
    background: #bbb;
    border-radius: 50%;
    animation: blink 1.4s infinite;
}
.typing div:nth-child(2) { animation-delay: 0.2s; }
.typing div:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
    0% { opacity: 0.2; transform: translateY(0); }
    50% { opacity: 1; transform: translateY(-3px); }
    100% { opacity: 0.2; transform: translateY(0); }
}

/* Composer */
.composer {
    background: var(--surface-light);
    border-top: 1px solid var(--border);
    padding: 18px 10px 8px; /* 10px h√∂her */
    display: flex;
    gap: 8px;
    align-items: flex-end;
    flex-shrink: 0;
}

.composer textarea {
    flex: 1;
    min-height: 40px;
    max-height: 140px;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    resize: none;
    overflow-y: hidden;
    font-size: 15px;
}

.mic-btn {
    width: 44px;
    height: 40px;
    border-radius: 10px;
    background: #444;
    color: white;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

.composer button.send-btn {
    background: var(--accent);
    border: none;
    padding: 12px 16px;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    height: 40px;
    min-width: 70px;
}
</style>
</head>

<body>

<div class="phone">

<!-- Header -->
<div class="header">
    <div class="ms-logo"><img src="Teams.png"></div>
    <div class="logo"><img src="00_Logo_CWE.png"></div>
</div>

<!-- Chatliste -->
<div id="chatList">
    <div class="chat-item" data-person="tina"><img src="Tina.png"><div class="info"><div class="name">Tina M√ºller</div><div class="role">Finanzabteilung</div></div></div>
    <div class="chat-item" data-person="christian"><img src="Christian.png"><div class="info"><div class="name">Christian Weber</div><div class="role">Marketing</div></div></div>
    <div class="chat-item" data-person="hakan"><img src="Hakan.png"><div class="info"><div class="name">Hakan Serdar</div><div class="role">Rechtsabteilung</div></div></div>
    <div class="chat-item" data-person="sophie"><img src="Sophie.png"><div class="info"><div class="name">Sophie Fischer</div><div class="role">Personalabteilung</div></div></div>
    <div class="chat-item" data-person="sarah"><img src="Sarah.png"><div class="info"><div class="name">Sarah Hosse</div><div class="role">Verkauf</div></div></div>
    <div class="chat-item" data-person="timo"><img src="Timo.png"><div class="info"><div class="name">Timo Jung</div><div class="role">Wirtschaftsanalyse</div></div></div>
    <div class="chat-item" data-person="elke"><img src="Elke.png"><div class="info"><div class="name">Elke Wagner</div><div class="role">Empfang, Ausbildung & Schule</div></div></div>
</div>

<!-- Chatfenster -->
<div id="chatWindow">
    <div class="chat-header">
        <span class="back-btn" id="backBtn">‚Üê</span>
        <img id="chatAvatar">
        <div><div class="name" id="chatName"></div></div>
    </div>

    <div class="desc" id="chatDescription"></div>

    <div class="messages" id="messages"></div>

    <div class="composer">
        <textarea id="input" placeholder="Nachricht eingeben..." rows="1"></textarea>
        <button class="mic-btn" id="micBtn">üé§</button>
        <button class="send-btn" id="send">Senden</button>
    </div>
</div>

</div>

<script>
/* Profile */
const profiles = {
    tina: { name: "Tina M√ºller", avatar: "Tina.png", desc: "Tina arbeitet in der Finanzabteilung..." },
    christian: { name: "Christian Weber", avatar: "Christian.png", desc: "Christian arbeitet im Marketing..." },
    hakan: { name: "Hakan Serdar", avatar: "Hakan.png", desc: "Hakan arbeitet in der Rechtsabteilung..." },
    sophie: { name: "Sophie Fischer", avatar: "Sophie.png", desc: "Sophie arbeitet im Personal..." },
    sarah: { name: "Sarah Hosse", avatar: "Sarah.png", desc: "Sarah arbeitet im Verkauf..." },
    timo: { name: "Timo Jung", avatar: "Timo.png", desc: "Timo ist Analyst..." },
    elke: { name: "Elke Wagner", avatar: "Elke.png", desc: "Elke arbeitet am Empfang..." }
};

const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const messagesDiv = document.getElementById("messages");
const chatDescription = document.getElementById("chatDescription");
const chatName = document.getElementById("chatName");
const chatAvatar = document.getElementById("chatAvatar");
const backBtn = document.getElementById("backBtn");
const input = document.getElementById("input");
const send = document.getElementById("send");
const micBtn = document.getElementById("micBtn");

let currentPerson = null;
const history = { tina: [], christian: [], hakan: [], sophie: [], sarah: [], timo: [], elke: [] };

/* Smooth Slide */
function openChat(person) {
    currentPerson = person;
    chatName.textContent = profiles[person].name;
    chatAvatar.src = profiles[person].avatar;

    chatDescription.textContent = profiles[person].desc;

    messagesDiv.innerHTML = "";
    history[person].forEach(msg => addMessage(msg.text, msg.who));

    chatWindow.classList.add("visible");
}

backBtn.addEventListener("click", () => {
    chatWindow.classList.remove("visible");
});

document.querySelectorAll(".chat-item").forEach(item => {
    item.addEventListener("click", () => openChat(item.dataset.person));
});

/* Autosize */
function adjustTextareaHeight() {
    input.style.height = "auto";
    input.style.height = input.scrollHeight + "px";
}
input.addEventListener("input", adjustTextareaHeight);

/* Messages */
function addMessage(text, who) {
    const div = document.createElement("div");
    div.className = "msg " + who;
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* Typing Indicator */
function showTypingIndicator() {
    const wrap = document.createElement("div");
    wrap.className = "typing";
    wrap.id = "typingIndicator";
    wrap.innerHTML = "<div></div><div></div><div></div>";
    messagesDiv.appendChild(wrap);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
function removeTypingIndicator() {
    const t = document.getElementById("typingIndicator");
    if (t) t.remove();
}

/* Send message */
async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    history[currentPerson].push({ text, who: "user" });

    input.value = "";
    adjustTextareaHeight();

    chatDescription.style.display = "none";

    showTypingIndicator();

    const messagesForApi = history[currentPerson].map(m => ({
        role: m.who === "user" ? "user" : "assistant",
        content: m.text
    }));

    try {
        const resp = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person: currentPerson, messages: messagesForApi })
        });

        const data = await resp.json();
        const answer = data.message?.content ?? "Fehler.";

        removeTypingIndicator();
        addMessage(answer, "bot");

        history[currentPerson].push({ text: answer, who: "bot" });

    } catch (error) {
        removeTypingIndicator();
        addMessage("Fehler bei der Anfrage.", "bot");
    }
}

send.addEventListener("click", sendMessage);

input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

/* Speech Recognition */
let recognition = null;
if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "de-DE";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = e => {
        input.value = e.results[0][0].transcript;
        adjustTextareaHeight();
    };
}

micBtn.addEventListener("click", () => {
    if (recognition) recognition.start();
});
</script>

</body>
</html>
