<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>CWE – Mitarbeiterchat</title>

<style>
  :root {
    --bg: #121212;
    --surface: #1E1E1E;
    --surface-light: #2A2A2A;
    --text: #EAEAEA;
    --text-dim: #A8A8A8;
    --accent: #6264A7;
    --bubble-user: #2F49B5;
    --bubble-bot: #2A2A2A;
    --border: #333;
    --desc-gray: #888;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: flex;
    justify-content: center;
    padding: 20px 0;
    height: 100vh;
    overflow: hidden;
  }
  .phone {
    width: 340px;
    height: 680px;
    background: var(--surface);
    border-radius: 35px;
    border: 2px solid #000;
    box-shadow: 0 0 40px rgba(0,0,0,0.6);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }

  /* HEADER */
  .header {
    background: white;
    height: 80px;
    padding: 0 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
    color: #000;
    user-select: none;
    flex-shrink: 0;
  }
  .header .ms-logo {
    position: absolute;
    left: 18px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .header .logo {
    position: absolute;
    right: 18px;
    height: 40px;
  }

  /* CHAT LIST */
  #chatList {
    flex: 1;
    overflow-y: auto;
  }
  .chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }
  .chat-item:hover {
    background: #2b2b2b;
  }
  .chat-item img {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--surface-light);
  }
  .info .name { font-size: 15px; font-weight: 600; }
  .info .role { font-size: 13px; color: var(--text-dim); }

  /* CHAT WINDOW */
  #chatWindow {
    display: none;
    flex-direction: column;
    height: 100%;
  }

  .chat-header {
    background: var(--surface-light);
    display: flex;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
  }
  .chat-header img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 15px;
  }
  .back-btn {
    font-size: 22px;
    cursor: pointer;
    margin-right: 15px;
    color: var(--accent);
  }

  .desc {
    background: var(--surface);
    color: var(--desc-gray);
    font-size: 13px;
    line-height: 1.4;
    margin: 10px 14px;
    padding: 8px;
    border-radius: 8px;
  }

  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .msg {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user { background: var(--bubble-user); align-self: flex-end; }
  .msg.bot { background: var(--bubble-bot); border: 1px solid var(--border); }

  /* COMPOSER */
  .composer {
    background: var(--surface-light);
    border-top: 1px solid var(--border);
    padding: 8px 10px;
    display: flex;
    gap: 8px;
    position: sticky;
    bottom: 0;
    z-index: 20;
    transition: transform 0.15s ease;
  }
  .composer textarea {
    flex: 1;
    min-height: 40px;
    max-height: 140px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    padding: 8px 10px;
    resize: none;
    overflow-y: hidden;
  }
  .composer button {
    background: var(--accent);
    color: #fff;
    border: 0;
    border-radius: 10px;
    padding: 12px 16px;
    cursor: pointer;
  }

  /* TYPING */
  .typing {
    display: flex;
    gap: 4px;
    background: var(--bubble-bot);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 10px 14px;
    align-self: flex-start;
  }
  .typing span {
    width: 6px;
    height: 6px;
    background: var(--text);
    border-radius: 50%;
    animation: bounce 1.2s infinite ease-in-out;
  }
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }
</style>
</head>

<body>
<div class="phone">

  <!---------------- HEADER ---------------->
  <div class="header">
    <div class="ms-logo"><img src="Teams.png"></div>
    Chats
    <div class="logo"><img src="00_Logo_CWE.png"></div>
  </div>

  <!--------------- CHAT LIST --------------->
  <div id="chatList">
    <div class="chat-item" data-person="tina">
      <img src="Tina.png"><div class="info"><div class="name">Tina Müller</div><div class="role">Finanzabteilung</div></div>
    </div>

    <div class="chat-item" data-person="christian">
      <img src="Christian.png"><div class="info"><div class="name">Christian Weber</div><div class="role">Marketing</div></div>
    </div>

    <div class="chat-item" data-person="hakan">
      <img src="Hakan.png"><div class="info"><div class="name">Hakan Serdar</div><div class="role">Rechtsabteilung</div></div>
    </div>

    <div class="chat-item" data-person="sophie">
      <img src="Sophie.png"><div class="info"><div class="name">Sophie Fischer</div><div class="role">Personalabteilung</div></div>
    </div>

    <div class="chat-item" data-person="sarah">
      <img src="Sarah.png"><div class="info"><div class="name">Sarah Hosse</div><div class="role">Verkauf</div></div>
    </div>

    <div class="chat-item" data-person="timo">
      <img src="Timo.png"><div class="info"><div class="name">Timo Jung</div><div class="role">Wirtschaftsanalyse</div></div>
    </div>

    <div class="chat-item" data-person="elke">
      <img src="Elke.png"><div class="info"><div class="name">Elke Wagner</div><div class="role">Empfang, Ausbildung & Schule</div></div>
    </div>
  </div>

  <!-------------- CHAT WINDOW --------------->
  <div id="chatWindow">

    <div class="chat-header">
      <span class="back-btn" id="backBtn">←</span>
      <img id="chatAvatar">
      <div class="name" id="chatName"></div>
    </div>

    <div class="desc" id="chatDescription"></div>

    <div class="messages" id="messages"></div>

    <div class="composer" id="composer">
      <textarea id="input" placeholder="Nachricht eingeben..."></textarea>
      <button id="send">Senden</button>
    </div>

  </div>
</div>

<script>
/* --- PROFILE DATA --- */
const profiles = {
  tina: { name: "Tina Müller", avatar: "Tina.png", desc: "Tina arbeitet in der Finanzabteilung ..." },
  christian: { name: "Christian Weber", avatar: "Christian.png", desc: "Christian arbeitet im Marketing ..." },
  hakan: { name: "Hakan Serdar", avatar: "Hakan.png", desc: "Hakan ist für Recht zuständig ..." },
  sophie: { name: "Sophie Fischer", avatar: "Sophie.png", desc: "Sophie arbeitet in der Personalabteilung ..." },
  sarah: { name: "Sarah Hosse", avatar: "Sarah.png", desc: "Sarah arbeitet im Verkauf ..." },
  timo: { name: "Timo Jung", avatar: "Timo.png", desc: "Timo ist Analyst bei der CWE ..." },
  elke: { name: "Elke Wagner", avatar: "Elke.png", desc: "Elke hilft dir bei allgemeinen Fragen & Ausbildung ..." }
};

const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const messagesDiv = document.getElementById("messages");
const chatDescription = document.getElementById("chatDescription");
const chatName = document.getElementById("chatName");
const chatAvatar = document.getElementById("chatAvatar");
const backBtn = document.getElementById("backBtn");
const input = document.getElementById("input");
const send = document.getElementById("send");
const composer = document.getElementById("composer");

let currentPerson = null;
const history = { tina: [], christian: [], hakan: [], sophie: [], sarah: [], timo: [], elke: [] };

/* --- UI FUNCTIONS --- */
function addMessage(text, who) {
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function openChat(person) {
  currentPerson = person;

  chatList.style.display = "none";
  chatWindow.style.display = "flex";

  chatName.textContent = profiles[person].name;
  chatAvatar.src = profiles[person].avatar;
  chatDescription.textContent = profiles[person].desc;

  messagesDiv.innerHTML = "";
  history[person].forEach(m => addMessage(m.text, m.who));

  input.value = "";
  adjustTextareaHeight();

  setTimeout(() => {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }, 50);
}

function adjustTextareaHeight() {
  input.style.height = "auto";
  input.style.height = input.scrollHeight + "px";
}

document.querySelectorAll(".chat-item").forEach(item =>
  item.addEventListener("click", () => openChat(item.dataset.person))
);

input.addEventListener("input", adjustTextareaHeight);

/* --- SEND MESSAGE --- */
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, "user");
  history[currentPerson].push({ text, who: "user" });

  input.value = "";
  adjustTextareaHeight();

  // Remove description after first user message
  chatDescription.style.display = "none";

  const typing = document.createElement("div");
  typing.className = "typing";
  typing.innerHTML = "<span></span><span></span><span></span>";
  messagesDiv.appendChild(typing);

  const payload = history[currentPerson].map(m => ({
    role: m.who === "user" ? "user" : "assistant",
    content: m.text
  }));

  try {
    const resp = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ person: currentPerson, messages: payload })
    });

    const data = await resp.json();
    messagesDiv.removeChild(typing);

    const answer = data.message?.content ?? "Fehler.";
    addMessage(answer, "bot");
    history[currentPerson].push({ text: answer, who: "bot" });

  } catch (err) {
    messagesDiv.removeChild(typing);
    addMessage("Fehler beim Senden.", "bot");
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

send.addEventListener("click", sendMessage);
input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

/* --- BACK BUTTON --- */
backBtn.addEventListener("click", () => {
  chatWindow.style.display = "none";
  chatList.style.display = "block";
});

/* ----------------------------------------------------
      iPHONE FIX — Tastatur verschiebt NUR den Composer
----------------------------------------------------- */
const vv = window.visualViewport;

function updateComposer() {
  if (!vv) return;

  const keyboardHeight = window.innerHeight - vv.height;

  if (keyboardHeight > 0) {
    composer.style.transform = `translateY(-${keyboardHeight}px)`;
  } else {
    composer.style.transform = "translateY(0)";
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

if (vv) {
  vv.addEventListener("resize", updateComposer);
  vv.addEventListener("scroll", updateComposer);
}

input.addEventListener("blur", () => {
  composer.style.transform = "translateY(0)";
});
</script>

</body>
</html>
