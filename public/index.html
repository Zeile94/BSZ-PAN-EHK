<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CWE ‚Äì Mitarbeiterchat</title>

  <style>
    :root {
      --bg: #121212;
      --surface: #1E1E1E;
      --surface-light: #2A2A2A;
      --text: #EAEAEA;
      --text-dim: #A8A8A8;
      --accent: #4C59F0;
      --bubble-user: #2F49B5;
      --bubble-bot: #2A2A2A;
      --border: #333;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      justify-content: center;
      padding: 20px 0;
    }

    /* iPhone Frame */
    .phone {
      width: 390px;
      height: 844px;
      background: var(--surface);
      border-radius: 35px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 2px solid #000;
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
    }

    /* HEADER */
    .header {
      background: var(--surface-light);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    /* CWE Logo rechts */
    .header .logo {
      position: absolute;
      right: 18px;
      color: var(--accent);
      font-weight: 700;
      font-size: 14px;
    }

    /* KONTAKTLISTE */
    #chatList {
      display: block;
      flex: 1;
      overflow-y: auto;
      background: var(--surface);
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 14px;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }

    .chat-item:hover {
      background: #2b2b2b;
    }

    .chat-item img {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-item .info .name {
      font-size: 15px;
      font-weight: 600;
    }
    .chat-item .info .role {
      font-size: 13px;
      color: var(--text-dim);
    }

    /* CHATFENSTER */
    #chatWindow {
      display: none;
      flex: 1;
      flex-direction: column;
      background: var(--surface);
    }

    .chat-header {
      display: flex;
      align-items: center;
      padding: 14px;
      background: var(--surface-light);
      border-bottom: 1px solid var(--border);
      gap: 12px;
      position: relative;
    }

    /* Zur√ºck-Button */
    .back-btn {
      position: absolute;
      left: 14px;
      font-size: 22px;
      cursor: pointer;
      color: var(--accent);
    }

    .chat-header img {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      object-fit: cover;
      margin-left: 30px;
    }

    .chat-header .name {
      font-size: 15px;
      font-weight: 600;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .msg.user {
      background: var(--bubble-user);
      align-self: flex-end;
    }

    .msg.bot {
      background: var(--bubble-bot);
      border: 1px solid var(--border);
      align-self: flex-start;
    }

    /* Composer */
    .composer {
      display: flex;
      padding: 10px;
      background: var(--surface-light);
      border-top: 1px solid var(--border);
      gap: 8px;
    }

    .composer textarea {
      flex: 1;
      min-height: 40px;
      max-height: 140px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      resize: none;
    }

    .composer button {
      background: var(--accent);
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      color: white;
      cursor: pointer;
    }

    /* B√ºroklammer */
    .attach {
      font-size: 22px;
      color: var(--text-dim);
      cursor: pointer;
      padding: 6px;
    }
  </style>
</head>
<body>

<div class="phone">

  <!-- HEADER -->
  <div class="header">
    Chats
    <div class="logo">CWE</div>
  </div>

  <!-- CHAT LIST -->
  <div id="chatList">

    <div class="chat-item" data-person="tina">
      <img src="DATA_URI_TINA" alt="Tina">
      <div class="info">
        <div class="name">Tina</div>
        <div class="role">Finanzabteilung</div>
      </div>
    </div>

    <div class="chat-item" data-person="christian">
      <img src="DATA_URI_CHRISTIAN" alt="Christian">
      <div class="info">
        <div class="name">Christian</div>
        <div class="role">Marketing</div>
      </div>
    </div>

    <div class="chat-item" data-person="hakan">
      <img src="DATA_URI_HAKAN" alt="Hakan">
      <div class="info">
        <div class="name">Hakan</div>
        <div class="role">Rechtsabteilung</div>
      </div>
    </div>

    <div class="chat-item" data-person="sophie">
      <img src="DATA_URI_SOPHIE" alt="Sophie">
      <div class="info">
        <div class="name">Sophie</div>
        <div class="role">Personalabteilung</div>
      </div>
    </div>

  </div>

  <!-- CHAT WINDOW -->
  <div id="chatWindow">

    <div class="chat-header">
      <span class="back-btn" id="backBtn">‚Üê</span>
      <img id="chatAvatar" src="">
      <div>
        <div class="name" id="chatName"></div>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <span class="attach">üìé</span>
      <textarea id="input" placeholder="Nachricht eingeben..."></textarea>
      <button id="send">Senden</button>
    </div>
  </div>

</div>

<script>
  const chatList = document.getElementById("chatList");
  const chatWindow = document.getElementById("chatWindow");
  const messagesDiv = document.getElementById("messages");
  const backBtn = document.getElementById("backBtn");
  const input = document.getElementById("input");
  const send = document.getElementById("send");
  const chatName = document.getElementById("chatName");
  const chatAvatar = document.getElementById("chatAvatar");

  let currentPerson = null;

  const profiles = {
    tina: { 
      name: "Tina", 
      avatar: "DATA_URI_TINA",
      system: "Du bist Tina aus der Finanzabteilung‚Ä¶"
    },
    christian: {
      name: "Christian",
      avatar: "DATA_URI_CHRISTIAN",
      system: "Du bist Christian aus dem Marketing‚Ä¶"
    },
    hakan: {
      name: "Hakan",
      avatar: "DATA_URI_HAKAN",
      system: "Du bist Hakan aus der Rechtsabteilung‚Ä¶"
    },
    sophie: {
      name: "Sophie",
      avatar: "DATA_URI_SOPHIE",
      system: "Du bist Sophie aus der Personalabteilung‚Ä¶"
    }
  };

  const history = {
    tina: [],
    christian: [],
    hakan: [],
    sophie: []
  };

  document.querySelectorAll(".chat-item").forEach(item => {
    item.addEventListener("click", () => {
      currentPerson = item.dataset.person;

      chatList.style.display = "none";
      chatWindow.style.display = "flex";

      chatName.textContent = profiles[currentPerson].name;
      chatAvatar.src = profiles[currentPerson].avatar;

      messagesDiv.innerHTML = "";

      history[currentPerson].forEach(msg => {
        addMessage(msg.text, msg.who);
      });
    });
  });

  backBtn.addEventListener("click", () => {
    chatWindow.style.display = "none";
    chatList.style.display = "block";
  });

  function addMessage(text, who) {
    const div = document.createElement("div");
    div.className = "msg " + who;
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    history[currentPerson].push({ text, who: "user" });

    const systemMessage = profiles[currentPerson].system;

    const lastUserMsg = history[currentPerson]
      .filter(m => m.who === "user")
      .slice(-2)
      .map(m => m.text)
      .join("\n");

    const resp = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: systemMessage + "\nBeziehe dich bei Anschlussfragen auf die vorherige Frage: " + lastUserMsg },
          { role: "user", content: text }
        ]
      })
    });

    const data = await resp.json();
    const answer = data.message?.content ?? "Fehler.";

    addMessage(answer, "bot");
    history[currentPerson].push({ text: answer, who: "bot" });

    input.value = "";
  }

  send.addEventListener("click", sendMessage);
  input.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>

</body>
</html>
