<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content, maximum-scale=1.0, user-scalable=no" />
<title>CWE – Mitarbeiterchat</title>
<style>
  :root {
    --bg: #121212;
    --surface: #1E1E1E;
    --surface-light: #2A2A2A;
    --text: #EAEAEA;
    --text-dim: #A8A8A8;
    --accent: #6264A7;
    --bubble-user: #2F49B5;
    --bubble-bot: #2A2A2A;
    --border: #333;
    --desc-gray: #888;
  }
  
  * { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent;
  }
  
  html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    position: fixed;
  }
  
  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }
  
  .phone {
    width: 100%;
    height: 100%;
    max-width: 100vw;
    max-height: 100vh;
    background: var(--surface);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    border-radius: 0;
    border: none;
    box-shadow: none;
  }
  
  @media (min-width: 769px) {
    .phone {
      width: 340px;
      height: 680px;
      border-radius: 35px;
      border: 2px solid #000;
      box-shadow: 0 0 40px rgba(0,0,0,0.6);
    }
  }
  
  .header {
    background: white;
    height: 60px;
    padding: 0 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
    color: #000000;
    user-select: none;
    flex-shrink: 0;
  }
  
  @media (min-width: 769px) {
    .header {
      height: 80px;
    }
  }
  
  .header .ms-logo {
    position: absolute;
    left: 18px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .header .ms-logo img {
    max-width: 100%;
    max-height: 100%;
    display: block;
  }
  
  .header .logo {
    position: absolute;
    right: 18px;
    height: 40px;
    width: auto;
  }
  
  .header .logo img {
    height: 40px;
    width: auto;
    display: block;
  }
  
  #chatList {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    background: var(--surface);
    display: block;
  }
  
  .chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }
  
  .chat-item:active {
    background: #2b2b2b;
  }
  
  .chat-item:hover {
    background: #2b2b2b;
  }
  
  .chat-item img {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--surface-light);
    flex-shrink: 0;
  }
  
  .chat-item .info .name {
    font-size: 15px;
    font-weight: 600;
  }
  
  .chat-item .info .role {
    font-size: 13px;
    color: var(--text-dim);
  }
  
  .desc {
    background: var(--surface);
    color: var(--desc-gray);
    font-size: 13px;
    line-height: 1.4;
    margin: 10px 14px;
    padding: 8px;
    border-radius: 8px;
    white-space: pre-wrap; 
    word-break: break-word;
  }
  
  #chatWindow {
    display: none;
    flex-direction: column;
    height: 100%;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--surface);
    flex: 1 1 auto;
    overflow: hidden;
    z-index: 5;
  }
  
  @media (min-width: 769px) {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      bottom: auto;
    }
  }
  
  .chat-header {
    background: var(--surface-light);
    display: flex;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
    flex-shrink: 0;
  }
  
  .back-btn {
    font-size: 22px;
    cursor: pointer;
    color: var(--accent);
    user-select: none;
    margin-right: 15px;
    flex-shrink: 0;
  }
  
  .chat-header img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--surface-light);
    margin-right: 15px;
    flex-shrink: 0;
  }
  
  .chat-header .name {
    font-size: 15px;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .messages {
    flex: 1 1 auto;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 10px 14px 60px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scrollbar-width: thin;
    scrollbar-color: var(--accent) transparent;
  }
  
  @media (min-width: 769px) {
    .messages {
      padding: 10px 14px;
    }
  }
  
  .msg {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  @media (min-width: 769px) {
    .msg {
      max-width: 75%;
    }
  }
  
  .msg.user { 
    background: var(--bubble-user); 
    align-self: flex-end; 
  }
  
  .msg.bot { 
    background: var(--bubble-bot); 
    border: 1px solid var(--border); 
    align-self: flex-start; 
  }
  
  .composer {
    background: var(--surface-light);
    border-top: 1px solid var(--border);
    padding: 8px 10px;
    display: flex;
    gap: 8px;
    align-items: flex-end;
    flex-shrink: 0;
    z-index: 20;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
  }
  
  @media (min-width: 769px) {
    .composer {
      position: relative;
      bottom: auto;
      left: auto;
      right: auto;
      width: auto;
    }
  }
  
  .composer textarea {
    flex: 1;
    min-height: 40px;
    max-height: 140px;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    resize: none;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    font-family: inherit;
    font-size: 15px;
    line-height: 1.4;
  }
  
  .composer button {
    background: var(--accent);
    border: none;
    padding: 12px 16px;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    user-select: none;
    flex-shrink: 0;
    height: 40px;
    min-width: 70px;
    font-weight: 600;
  }
  
  .composer button:active {
    opacity: 0.8;
  }
  
  /* Typing Indicator */
  .typing {
    display: flex;
    align-items: center;
    gap: 4px;
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 14px;
    background: var(--bubble-bot);
    border: 1px solid var(--border);
    align-self: flex-start;
    font-size: 14px;
  }
  
  @media (min-width: 769px) {
    .typing {
      max-width: 75%;
    }
  }
  
  .typing span {
    display: block;
    width: 6px;
    height: 6px;
    background: var(--text);
    border-radius: 50%;
    animation: bounce 1.2s infinite ease-in-out;
  }
  
  .typing span:nth-child(1) { animation-delay: 0s; }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }
</style>
</head>
<body>
<div class="phone">
  <div class="header">
    <div class="ms-logo"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='10' width='35' height='35' fill='%235B5FC7'/%3E%3Crect x='55' y='10' width='35' height='35' fill='%2370AD47'/%3E%3Crect x='10' y='55' width='35' height='35' fill='%23FFBB33'/%3E%3Crect x='55' y='55' width='35' height='35' fill='%23FF5630'/%3E%3C/svg%3E" alt="Teams Logo"></div>
    Chats
    <div class="logo"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='70' font-size='80' font-weight='bold' text-anchor='middle' fill='%236264A7'%3ECWE%3C/text%3E%3C/svg%3E" alt="CWE Logo"></div>
  </div>
 
  <div id="chatList">
    <div class="chat-item" data-person="tina">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E" alt="Tina" />
      <div class="info">
        <div class="name">Tina Müller</div>
        <div class="role">Finanzabteilung</div>
      </div>
    </div>
    <div class="chat-item" data-person="christian">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E" alt="Christian" />
      <div class="info">
        <div class="name">Christian Weber</div>
        <div class="role">Marketing</div>
      </div>
    </div>
    <div class="chat-item" data-person="hakan">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E" alt="Hakan" />
      <div class="info">
        <div class="name">Hakan Serdar</div>
        <div class="role">Rechtsabteilung</div>
      </div>
    </div>
    <div class="chat-item" data-person="sophie">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E" alt="Sophie" />
      <div class="info">
        <div class="name">Sophie Fischer</div>
        <div class="role">Personalabteilung</div>
      </div>
    </div>
    <div class="chat-item" data-person="sarah">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E" alt="Sarah" />
      <div class="info">
        <div class="name">Sarah Hosse</div>
        <div class="role">Verkauf</div>
      </div>
    </div>
    <div class="chat-item" data-person="timo">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E" alt="Timo" />
      <div class="info">
        <div class="name">Timo Jung</div>
        <div class="role">Wirtschaftsanalyse</div>
      </div>
    </div>
    <div class="chat-item" data-person="elke">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E" alt="Elke" />
      <div class="info">
        <div class="name">Elke Wagner</div>
        <div class="role">Empfang, Ausbildung & Schule</div>
      </div>
    </div>
  </div>
 
  <div id="chatWindow">
    <div class="chat-header">
      <span class="back-btn" id="backBtn">←</span>
      <img id="chatAvatar" src="" alt="Avatar" />
      <div><div class="name" id="chatName"></div></div>
    </div>
    <div class="desc" id="chatDescription"></div>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <textarea id="input" placeholder="Nachricht schreiben..." rows="1"></textarea>
      <button id="send">Senden</button>
    </div>
  </div>
</div>
 
<script>
const profiles = {
  tina: {
    name: "Tina Müller",
    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E",
    desc: "Tina arbeitet in der Finanzabteilung und ist dir bei allen Fragestellungen rund um Finanzen behilflich."
  },
  christian: {
    name: "Christian Weber",
    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E",
    desc: "Christian arbeitet in der Marketingabteilung und ist dir bei allen Fragestellungen rund um Marketing behilflich."
  },
  hakan: {
    name: "Hakan Serdar",
    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E",
    desc: "Hakan arbeitet in der Rechtsabteilung und ist dir bei allen rechtlichen Fragestellungen behilflich."
  },
  sophie: {
    name: "Sophie Fischer",
    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E",
    desc: "Sophie arbeitet in der Personalabteilung und ist dir bei allen Fragestellungen rund um Personal behilflich."
  },
  sarah: {
    name: "Sarah Hosse",
    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E",
    desc: "Sarah arbeitet im Verkauf und ist dir bei allen Fragestellungen rund um den Verkauf behilflich."
  },
  timo: {
    name: "Timo Jung",
    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E",
    desc: "Timo arbeitet als Analyst bei der CWE und ist dir bei allen volkswirtschaftlichen Fragestellungen behilflich."
  },
  elke: {
    name: "Elke Wagner",
    avatar: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect width='200' height='200' fill='%23d0d0d0'/%3E%3Ccircle cx='100' cy='60' r='35' fill='%23888'/%3E%3Cpath d='M60 120 Q100 100 140 120 L140 180 Q100 200 60 180 Z' fill='%23888'/%3E%3C/svg%3E",
    desc: "Elke arbeitet am Empfang und ist dir bei allen Fragestellungen behilflich, bei denen dir sonst niemand helfen kann. Außerdem ist sie deine Ausbildungskoordinatorin und hilft dir auch bei Fragen rund um die Berufsschule weiter."
  }
};
 
const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const messagesDiv = document.getElementById("messages");
const chatDescription = document.getElementById("chatDescription");
const chatName = document.getElementById("chatName");
const chatAvatar = document.getElementById("chatAvatar");
const backBtn = document.getElementById("backBtn");
const input = document.getElementById("input");
const send = document.getElementById("send");
const phone = document.querySelector(".phone");
 
let currentPerson = null;
const history = { tina: [], christian: [], hakan: [], sophie: [], sarah: [], timo: [], elke: [] };
 
function addMessage(text, who) {
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.textContent = text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
 
function moveChatItemToTop(person) {
  const item = document.querySelector(`.chat-item[data-person="${person}"]`);
  if (item) {
    chatList.removeChild(item);
    chatList.insertBefore(item, chatList.firstChild);
  }
}
 
function openChat(person) {
  currentPerson = person;
  chatList.style.display = "none";
  chatWindow.style.display = "flex";
 
  chatName.textContent = profiles[person].name;
  chatAvatar.src = profiles[person].avatar;
 
  chatDescription.textContent = profiles[person].desc;
  chatDescription.style.display = "block";
 
  messagesDiv.innerHTML = "";
  history[person].forEach(msg => addMessage(msg.text, msg.who));
 
  input.value = "";
  adjustTextareaHeight();
 
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
 
  moveChatItemToTop(person);
  
  setTimeout(() => {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }, 100);
}
 
function adjustTextareaHeight() {
  input.style.height = "auto";
  input.style.height = Math.min(input.scrollHeight, 140) + "px";
}
 
document.querySelectorAll(".chat-item").forEach(item => {
  item.addEventListener("click", () => {
    openChat(item.dataset.person);
  });
});
 
input.addEventListener("input", () => {
  adjustTextareaHeight();
});

input.addEventListener("focus", () => {
  setTimeout(() => {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }, 300);
});
 
async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
 
  addMessage(text, "user");
  history[currentPerson].push({ text, who: "user" });
 
  input.value = "";
  adjustTextareaHeight();
 
  if (chatDescription.style.display !== "none") {
    chatDescription.style.display = "none";
  }
 
  // Typing Indicator einfügen
  const typingDiv = document.createElement("div");
  typingDiv.className = "typing";
  typingDiv.innerHTML = `<span></span><span></span><span></span>`;
  messagesDiv.appendChild(typingDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
 
  const messagesForApi = history[currentPerson].map(m => ({
    role: m.who === "user" ? "user" : "assistant",
    content: m.text
  }));
 
  try {
    const resp = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ person: currentPerson, messages: messagesForApi })
    });
    const data = await resp.json();
 
    // Typing Indicator entfernen
    if (typingDiv.parentNode) {
      messagesDiv.removeChild(typingDiv);
    }
 
    const answer = data.message?.content ?? "Fehler.";
    addMessage(answer, "bot");
    history[currentPerson].push({ text: answer, who: "bot" });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } catch (error) {
    if (typingDiv.parentNode) {
      messagesDiv.removeChild(typingDiv);
    }
    addMessage("Beim Senden der Nachricht ist ein Fehler aufgetreten.", "bot");
  }
}
 
send.addEventListener("click", sendMessage);
input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
 
backBtn.addEventListener("click", () => {
  chatWindow.style.display = "none";
  chatList.style.display = "block";
  input.blur();
});

// Handle viewport changes when keyboard opens/closes
window.visualViewport?.addEventListener("resize", () => {
  if (chatWindow.style.display === "flex") {
    setTimeout(() => {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, 100);
  }
});

// Alternative for older devices
window.addEventListener("orientationchange", () => {
  setTimeout(() => {
    if (chatWindow.style.display === "flex") {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  }, 500);
});
</script>
</body>
</html>
