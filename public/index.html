<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>CWE - Mitarbeiterchat</title>
<style>
:root {
  --bg: #121212;
  --surface: #1E1E1E;
  --surface-light: #2A2A2A;
  --text: #EAEAEA;
  --text-dim: #A8A8A8;
  --accent: #6264A7;
  --action: #6264A7; /* einheitliche Aktionsfarbe (Senden-Icon, Zurück-Button) */
  --bubble-user: var(--action);
  --bubble-bot: #2A2A2A;
  --border: #333;
  --desc-gray: #888;
  --teams-blue: #6264A7;
  --app-header-height: 70px;
}
* {
  box-sizing: border-box;
}
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  touch-action: manipulation;
}
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  display: flex;
  justify-content: center;
  align-items: stretch;
  font-size: 17px; /* global +1 */
  overscroll-behavior: none; /* verhindert Browsertab/Seiten-Scrollsprünge */
}
.phone {
  width: 100%;
  max-width: 600px;
  height: 100dvh;
  min-height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}
.app-header {
  background: white;
  height: var(--app-header-height);
  padding: 0 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 600;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  color: #000000;
  user-select: none;
  flex-shrink: 0;
}
.app-header .ms-logo {
  position: absolute;
  left: 18px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.app-header .ms-logo img {
  max-width: 100%;
  max-height: 100%;
}
.app-header .logo {
  position: absolute;
  right: 18px;
  height: 40px;
}
.app-header .logo img {
  height: 40px;
  width: auto;
}
#chatList, #chatWindow {
  position: absolute;
  left: 0; right: 0;
  top: var(--app-header-height);
  bottom: 0;
  transition: transform 0.35s ease, opacity 0.35s ease;
  will-change: transform, opacity;
  background: var(--surface);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  -webkit-overflow-scrolling: touch;
}
#chatList.visible {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
  z-index: 40;
}
#chatList.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateX(-100%);
  z-index: 0;
}
#chatWindow.visible {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
  z-index: 50;
  display: flex;
}
#chatWindow.hidden {
  opacity: 0;
  pointer-events: none;
  transform: translateX(100%);
  z-index: 0;
  display: flex;
}
#chatList {
  background: var(--surface);
}
.chat-item {
  display: flex;
  align-items: center;
  padding: 12px;
  gap: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}
.chat-item:hover {
  background: #2b2b2b;
}
.chat-item img {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  object-fit: cover;
  background: var(--surface-light);
}
.chat-item .info .name {
  font-size: 16px;
  font-weight: 600;
}
.chat-item .info .role {
  font-size: 14px;
  color: var(--text-dim);
}
.desc {
  background: var(--surface);
  color: var(--desc-gray);
  font-size: 14px;
  line-height: 1.4;
  margin: 10px 14px;
  padding: 8px;
  border-radius: 8px;
  white-space: pre-wrap;
  word-break: break-word;
}
#chatWindow {
  flex-direction: column;
  overflow: hidden;
}
.chat-header {
  background: var(--surface-light);
  display: flex;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  position: relative;
  top: auto;
  z-index: 1;
  flex-shrink: 0;
}
.back-btn {
  font-size: 23px;
  cursor: pointer;
  color: var(--action);
  margin-right: 15px;
  user-select: none;
}
.chat-header img {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  background: var(--surface-light);
  margin-right: 15px;
}
.chat-header .name {
  font-size: 16px;
  font-weight: 600;
}
.messages {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 10px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  scrollbar-width: thin;
  scrollbar-color: var(--accent) transparent;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
.msg {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 15px;
  line-height: 1.4;
  white-space: pre-wrap;
  word-break: break-word;
  color: var(--text);
}
.msg.user {
  background: var(--bubble-user);
  align-self: flex-end;
}
.msg.bot {
  background: var(--bubble-bot);
  border: 1px solid var(--border);
  align-self: flex-start;
}
#chatWindow.content-building .desc,
#chatWindow.content-building .messages {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
}
.composer {
  background: var(--surface);
  border: none;
  padding: 8px 0;
  display: flex;
  gap: 8px;
  align-items: flex-end;
  flex-shrink: 0;
  position: sticky;
  bottom: 0;
  height: 65px;
  transform: translateY(-7.5px);
  transition: bottom 0.3s ease;
}
.composer-inner {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  width: 100%;
  transform: translateY(-5px);
  padding-left: 30px;
  padding-right: 20px;
}
.composer textarea {
  flex: 1;
  min-height: 40px;
  max-height: 140px;
  background: var(--surface);
  color: var(--text);
  border: 0.7px solid white;
  border-radius: 10px;
  padding: 8px 20px 8px 20px;
  resize: none;
  overflow-y: hidden;
  font-family: inherit;
  font-size: 16px;
  line-height: 1.4;
  height: 40px;
  margin-bottom: 0;
  position: relative;
  bottom: 0;
  outline: none;
  box-shadow: none;
  max-width: none;
}
.send-icon {
  width: 40px;
  height: 40px;
  cursor: pointer;
  fill: var(--action);
  flex-shrink: 0;
  user-select: none;
  transition: filter 0.2s ease;
  margin-right: 0;
  vertical-align: bottom;
  outline: none;
}
.send-icon:hover,
.send-icon:active,
.send-icon:focus {
  filter: none;
  outline: none;
  box-shadow: none;
}
.upload-btn {
  width: 40px;
  height: 40px;
  cursor: pointer;
  color: var(--action);
  border: none;
  background: transparent;
  font-size: 28px;
  font-weight: 600;
  line-height: 40px;
  padding: 0;
  user-select: none;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-shrink: 0;
  transition: filter 0.2s ease;
}
.upload-btn:hover,
.upload-btn:focus {
  filter: brightness(1.2);
  outline: none;
}
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}
.pop-bubble {
  display: inline-flex;
  max-width: 70%;
  gap: 6px;
  margin-bottom: 10px;
  align-items: center;
  white-space: nowrap;
}
.pop-dot {
  width: 10px;
  height: 10px;
  background-color: var(--teams-blue);
  border-radius: 50%;
  animation-name: bounce;
  animation-duration: 1.2s;
  animation-iteration-count: infinite;
  animation-timing-function: ease-in-out;
}
.pop-dot:nth-child(1) {
  animation-delay: 0s;
}
.pop-dot:nth-child(2) {
  animation-delay: 0.2s;
}
.pop-dot:nth-child(3) {
  animation-delay: 0.4s;
}
.hidden-element { display: none !important; }
</style>
</head>
<body>
<div class="phone">
  <div class="app-header">
    <div class="ms-logo"><img src="Teams.png" alt="Microsoft Teams Logo"></div>
    <div class="logo"><img src="00_Logo_CWE.png" alt="CWE Logo"></div>
  </div>
  <div id="chatList" class="visible">
    <div class="chat-item" data-person="tina">
      <img src="Tina.png" alt="Tina Müller" />
      <div class="info"><div class="name">Tina Müller</div><div class="role">Finanzabteilung</div></div>
    </div>
    <div class="chat-item" data-person="christian">
      <img src="Christian.png" alt="Christian Weber" />
      <div class="info"><div class="name">Christian Weber</div><div class="role">Marketing</div></div>
    </div>
    <div class="chat-item" data-person="hakan">
      <img src="Hakan.png" alt="Hakan Serdar" />
      <div class="info"><div class="name">Hakan Serdar</div><div class="role">Rechtsabteilung</div></div>
    </div>
    <div class="chat-item" data-person="sophie">
      <img src="Sophie.png" alt="Sophie Fischer" />
      <div class="info"><div class="name">Sophie Fischer</div><div class="role">Personalabteilung</div></div>
    </div>
    <div class="chat-item" data-person="sarah">
      <img src="Sarah.png" alt="Sarah Hosse" />
      <div class="info"><div class="name">Sarah Hosse</div><div class="role">Verkauf</div></div>
    </div>
    <div class="chat-item" data-person="timo">
      <img src="Timo.png" alt="Timo Jung" />
      <div class="info"><div class="name">Timo Jung</div><div class="role">Wirtschaftsanalyse</div></div>
    </div>
    <div class="chat-item" data-person="elke">
      <img src="Elke.png" alt="Elke Wagner" />
      <div class="info"><div class="name">Elke Wagner</div><div class="role">Empfang, Ausbildung & Schule</div></div>
    </div>
  </div>
  <div id="chatWindow" class="hidden content-building" aria-hidden="true">
    <div class="chat-header">
      <span class="back-btn" id="backBtn" role="button" tabindex="0">←</span>
      <img id="chatAvatar" src="" alt="Avatar" />
      <div><div class="name" id="chatName"></div></div>
    </div>
    <div class="desc" id="chatDescription"></div>
    <div class="messages" id="messages" aria-live="polite"></div>
    <div class="composer" aria-label="Nachrichtenbereich">
      <div class="composer-inner">
        <button type="button" class="upload-btn" id="uploadBtn" title="Datei hochladen">+</button>
        <input type="file" id="fileInput" multiple class="hidden-element" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv" />
        <textarea id="input" placeholder="Nachricht eingeben..." rows="1" aria-label="Nachricht eingeben"></textarea>
        <svg id="send" class="send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-label="Senden" role="button" tabindex="0" >
          <path d="M2.01 21L23 12 2.01 3v7l15 2-15 2z"/>
        </svg>
      </div>
    </div>
  </div>
</div>
<script>
const profiles = {
  tina: { name: "Tina Müller", avatar: "Tina.png", desc: "Tina arbeitet in der Finanzabteilung und ist dir bei allen Fragestellungen rund um Finanzen behilflich." },
  christian: { name: "Christian Weber", avatar: "Christian.png", desc: "Christian arbeitet in der Marketingabteilung und ist dir bei allen Fragestellungen rund um Marketing behilflich." },
  hakan: { name: "Hakan Serdar", avatar: "Hakan.png", desc: "Hakan arbeitet in der Rechtsabteilung und ist dir bei allen rechtlichen Fragestellungen behilflich." },
  sophie: { name: "Sophie Fischer", avatar: "Sophie.png", desc: "Sophie arbeitet in der Personalabteilung und ist dir bei allen Fragestellungen rund um Personal behilflich." },
  sarah: { name: "Sarah Hosse", avatar: "Sarah.png", desc: "Sarah arbeitet im Verkauf und ist dir bei allen Fragestellungen rund um den Verkauf behilflich." },
  timo: { name: "Timo Jung", avatar: "Timo.png", desc: "Timo arbeitet als Analyst bei der CWE und ist dir bei allen volkswirtschaftlichen Fragestellungen behilflich." },
  elke: { name: "Elke Wagner", avatar: "Elke.png", desc: "Elke arbeitet am Empfang und ist dir bei allen Fragestellungen behilflich, bei denen dir sonst niemand helfen kann. Außerdem ist sie deine Ausbildungskoordinatorin und hilft dir auch bei Fragen rund um die Berufsschule weiter." }
};
const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const messagesDiv = document.getElementById("messages");
const chatDescription = document.getElementById("chatDescription");
const chatName = document.getElementById("chatName");
const chatAvatar = document.getElementById("chatAvatar");
const backBtn = document.getElementById("backBtn");
const input = document.getElementById("input");
const send = document.getElementById("send");
const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("fileInput");

let currentPerson = null;
const history = { tina: [], christian: [], hakan: [], sophie: [], sarah: [], timo: [], elke: [] };
let popBubbleElement = null;
let pendingFiles = [];

function hideChatContent() { chatWindow.classList.add('content-building'); }
function showChatContent() { chatWindow.classList.remove('content-building'); }

function scrollToBottom({ smooth = true } = {}) {
  const behavior = smooth ? 'smooth' : 'auto';
  requestAnimationFrame(() => {
    try { messagesDiv.scrollTo({ top: messagesDiv.scrollHeight, behavior }); } catch (e) { messagesDiv.scrollTop = messagesDiv.scrollHeight; }
  });
}

function addMessage(text, who, { scroll = true } = {}) {
  const div = document.createElement("div");
  div.className = "msg " + who;
  div.textContent = text;
  messagesDiv.appendChild(div);
  if (scroll) scrollToBottom();
  return div;
}

function addFileMessage(fileObject, who = "user") {
  const div = document.createElement("div");
  div.className = "msg " + who;
  if (fileObject.isImage) {
    const img = document.createElement("img");
    img.src = fileObject.content;
    img.style.maxWidth = "100%";
    img.style.borderRadius = "10px";
    img.style.display = "block";
    div.appendChild(img);
  } else {
    const link = document.createElement("a");
    link.href = fileObject.content;
    link.textContent = `Datei: ${fileObject.name}`;
    link.download = fileObject.name;
    link.style.color = 'var(--accent)';
    div.appendChild(link);
  }
  messagesDiv.appendChild(div);
  scrollToBottom();
  return div;
}

function moveChatItemToTop(person) {
  const item = document.querySelector(`.chat-item[data-person="${person}"]`);
  if (item) {
    chatList.removeChild(item);
    chatList.insertBefore(item, chatList.firstChild);
  }
}

function openChat(person) {
  currentPerson = person;
  hideChatContent();
  chatWindow.classList.add('hidden');
  chatWindow.classList.remove('visible');
  chatWindow.setAttribute('aria-hidden', 'true');
  chatList.classList.remove('hidden');
  chatList.classList.add('visible');
  chatName.textContent = profiles[person].name;
  chatAvatar.src = profiles[person].avatar;
  if (history[person].length === 0) {
    chatDescription.textContent = profiles[person].desc;
    chatDescription.style.display = "block";
  } else {
    chatDescription.style.display = "none";
  }
  messagesDiv.innerHTML = "";
  const prevScrollBehavior = messagesDiv.style.scrollBehavior;
  messagesDiv.style.scrollBehavior = 'auto';
  history[person].forEach(msg => {
    const div = document.createElement("div");
    div.className = "msg " + msg.who;
    if (msg.file) {
      if (msg.isImage) {
        const img = document.createElement("img");
        img.src = msg.file;
        img.style.maxWidth = "100%";
        img.style.borderRadius = "10px";
        img.style.display = "block";
        div.appendChild(img);
      } else {
        const link = document.createElement("a");
        link.href = msg.file;
        link.textContent = msg.text || `(Datei: ${msg.fileName})`;
        link.download = msg.fileName;
        link.style.color = 'var(--accent)';
        div.appendChild(link);
      }
    } else {
      div.textContent = msg.text;
    }
    messagesDiv.appendChild(div);
  });
  scrollToBottom({ smooth: false });
  messagesDiv.style.scrollBehavior = prevScrollBehavior || '';
  input.value = "";
  adjustTextareaHeight();
  requestAnimationFrame(() => {
    void chatWindow.offsetHeight;
    chatWindow.classList.remove('hidden');
    chatWindow.classList.add('visible');
    chatWindow.setAttribute('aria-hidden', 'false');
    chatList.classList.remove('visible');
    chatList.classList.add('hidden');
    chatWindow.addEventListener('transitionend', () => { showChatContent(); }, { once: true });
  });
}

function backToChatList() {
  try {
    if (document.activeElement) document.activeElement.blur();
    if (input) input.blur();
  } catch (e) {}
  hideChatContent();
  chatList.classList.remove('hidden');
  chatList.classList.add('visible');
  chatWindow.classList.remove('visible');
  chatWindow.classList.add('hidden');
  chatWindow.setAttribute('aria-hidden', 'true');
  currentPerson = null;
}

function adjustTextareaHeight() {
  input.style.height = "auto";
  const minHeight = 40;
  const maxHeight = 140;
  const scrollHeight = input.scrollHeight;
  if (scrollHeight < minHeight) {
    input.style.height = minHeight + "px";
    input.style.overflowY = "hidden";
  } else if (scrollHeight > maxHeight) {
    input.style.height = maxHeight + "px";
    input.style.overflowY = "scroll";
  } else {
    input.style.height = scrollHeight + "px";
    input.style.overflowY = "hidden";
  }
  let growAmount = scrollHeight - 40;
  if (growAmount < 0) growAmount = 0;
  input.style.marginTop = `-${growAmount}px`;
}
function isTouchDevice() {
  return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
}
document.querySelectorAll(".chat-item").forEach(item => {
  item.addEventListener("click", () => openChat(item.dataset.person));
});
function showPopBubble() {
  if (popBubbleElement) return;
  popBubbleElement = document.createElement("div");
  popBubbleElement.className = "pop-bubble";
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement("div");
    dot.className = "pop-dot";
    dot.style.animationDelay = (i * 0.2) + "s";
    popBubbleElement.appendChild(dot);
  }
  messagesDiv.appendChild(popBubbleElement);
  scrollToBottom();
}
function removePopBubble() {
  if (popBubbleElement) {
    popBubbleElement.remove();
    popBubbleElement = null;
  }
}

function readTextFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(reader.error);
    reader.readAsText(file);
  });
}

uploadBtn.addEventListener('click', () => { fileInput.click(); });

fileInput.addEventListener('change', async (event) => {
  const files = event.target.files;
  if (files.length === 0) return;
  if (!currentPerson) return;
  for (const file of files) {
    let fileObject = { name: file.name, content: null, isImage: false, text: null };
    if (file.type.startsWith('image/')) {
      fileObject.isImage = true;
      fileObject.content = URL.createObjectURL(file);
    } else if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.csv')) {
      try {
        fileObject.text = await readTextFile(file);
        fileObject.content = null;
      } catch (e) {
        fileObject.text = 'Fehler beim Lesen der Textdatei.';
      }
    } else {
      fileObject.text = `(Datei: ${file.name})`;
      fileObject.content = URL.createObjectURL(file);
    }
    pendingFiles.push(fileObject);
    addFileMessage(fileObject, 'user');
  }
});

async function sendMessage() {
  const text = input.value.trim();
  if (!text && pendingFiles.length === 0 && !currentPerson) return;
  if (text) {
    addMessage(text, "user");
    history[currentPerson].push({ text, who: "user" });
  }
  for (const fileObj of pendingFiles) {
    let fileText = fileObj.text || '';
    if (fileObj.isImage) {
      fileText = `Bilddatei hochgeladen: ${fileObj.name}`;
    } else if (!fileText) {
      fileText = `Datei hochgeladen: ${fileObj.name}`;
    }
    history[currentPerson].push({ who: 'user', text: fileText, file: fileObj.content, fileName: fileObj.name, isImage: fileObj.isImage });
  }
  pendingFiles = [];
  showPopBubble();
  input.value = "";
  adjustTextareaHeight();
  if (chatDescription.style.display !== "none") {
    chatDescription.style.display = "none";
  }
  try {
    const resp = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ person: currentPerson, messages: buildMessages() })
    });
    const data = await resp.json();
    const answer = data.message?.content ?? "Fehler.";
    removePopBubble();
    addMessage(answer, "bot");
    history[currentPerson].push({ text: answer, who: "bot" });
    moveChatItemToTop(currentPerson);
  } catch (error) {
    removePopBubble();
    addMessage("Beim Senden der Nachricht ist ein Fehler aufgetreten.", "bot");
  }
}

input.addEventListener("keydown", e => {
  if (isTouchDevice()) return;
  if (e.key === "Enter") {
    if (e.shiftKey) return;
    e.preventDefault();
    sendMessage();
  }
});
input.addEventListener("input", () => adjustTextareaHeight());
send.addEventListener("click", sendMessage);
backBtn.addEventListener("click", backToChatList);
backBtn.addEventListener("keydown", (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    backToChatList();
  }
});
</script>
</body>
</html>
