<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>CWE – Mitarbeiterchat</title>

<style>
:root {
    --bg: #121212;
    --surface: #1E1E1E;
    --surface-light: #2A2A2A;
    --text: #EAEAEA;
    --text-dim: #A8A8A8;
    --accent: #6264A7;
    --bubble-user: #2F49B5;
    --bubble-bot: #2A2A2A;
    --border: #333;
    --desc-gray: #888;
}

* { box-sizing: border-box; }

/* === Voll-Responsive Layout === */
html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    touch-action: none; /* Verhindert Verschieben auf Touch-Geräten */
}

body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    display: flex;
    justify-content: center;
    align-items: stretch;
}

.phone {
    width: 100%;
    max-width: 600px;
    height: 100vh;
    background: var(--surface);
    border-radius: 0;
    border: none;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
.header {
    background: white;
    height: 70px;
    padding: 0 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
    color: #000000;
    user-select: none;
    flex-shrink: 0;
}
.header .ms-logo {
    position: absolute;
    left: 18px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.header .ms-logo img {
    max-width: 100%;
    max-height: 100%;
}
.header .logo {
    position: absolute;
    right: 18px;
    height: 40px;
}
.header .logo img {
    height: 40px;
    width: auto;
}

/* Chatliste */
#chatList {
    flex: 1;
    overflow-y: auto;
    background: var(--surface);
}

.chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
}
.chat-item:hover {
    background: #2b2b2b;
}
.chat-item img {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--surface-light);
}
.chat-item .info .name {
    font-size: 15px;
    font-weight: 600;
}
.chat-item .info .role {
    font-size: 13px;
    color: var(--text-dim);
}

/* Beschreibung */
.desc {
    background: var(--surface);
    color: var(--desc-gray);
    font-size: 13px;
    line-height: 1.4;
    margin: 10px 14px;
    padding: 8px;
    border-radius: 8px;
    white-space: pre-wrap;
    word-break: break-word;
}

/* Chatfenster */
#chatWindow {
    display: none;
    flex-direction: column;
    height: 100%;
    background: var(--surface);
    overflow: hidden;
}

.chat-header {
    background: var(--surface-light);
    display: flex;
    align-items: center;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 10;
    flex-shrink: 0;
}
.back-btn {
    font-size: 22px;
    cursor: pointer;
    color: var(--accent);
    margin-right: 15px;
}
.chat-header img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--surface-light);
    margin-right: 15px;
}
.chat-header .name {
    font-size: 15px;
    font-weight: 600;
}

/* Nachrichten */
.messages {
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 10px 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scrollbar-width: thin;
    scrollbar-color: var(--accent) transparent;
}

.msg {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 14px;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-break: break-word;
}
.msg.user {
    background: var(--bubble-user);
    align-self: flex-end;
}
.msg.bot {
    background: var(--bubble-bot);
    border: 1px solid var(--border);
    align-self: flex-start;
}

/* Composer */
/* Höhe um ca. 30% erhöht + 12.5px oben drauf (ca. 73px + 12.5px = 85.5px) */
.composer {
    background: var(--surface-light);
    border-top: 1px solid var(--border);
    padding: 8px 10px;
    display: flex;
    gap: 8px;
    align-items: center;
    flex-shrink: 0;
    position: sticky;
    bottom: 0;
    height: 85.5px; /* erhöhte feste Höhe */
}

/* Container um Eingabefeld und Button, um diese höher zu setzen */
.composer-inner {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    /* Gesamt Verschiebung um 10px (1cm) nach oben */
    transform: translateY(-10px);
}

/* Textarea Styling */
/* Statisch: Horizontale Breite abzüglich Button + gap */
.composer textarea {
    flex: 1;
    min-height: 40px;
    max-height: 140px;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    resize: none;
    overflow-y: hidden;
    font-family: inherit;
    font-size: 15px;
    line-height: 1.4;
    height: 40px; /* initiale Höhe */
    max-width: calc(100% - 70px - 8px); /* Breite des Buttons + gap */
    margin-bottom: 0;
}

/* Button bleibt unverändert */
.composer button {
    background: var(--accent);
    border: none;
    padding: 12px 16px;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    flex-shrink: 0;
    height: 40px;
    min-width: 70px;
    max-width: 70px;
}

</style>
</head>

<body>
<div class="phone">

<div class="header">
    <div class="ms-logo"><img src="Teams.png" alt="Microsoft Teams Logo"></div>
    <div class="logo"><img src="00_Logo_CWE.png" alt="CWE Logo"></div>
</div>

<div id="chatList">
    <div class="chat-item" data-person="tina">
        <img src="Tina.png" />
        <div class="info">
            <div class="name">Tina Müller</div>
            <div class="role">Finanzabteilung</div>
        </div>
    </div>

    <div class="chat-item" data-person="christian">
        <img src="Christian.png" />
        <div class="info">
            <div class="name">Christian Weber</div>
            <div class="role">Marketing</div>
        </div>
    </div>

    <div class="chat-item" data-person="hakan">
        <img src="Hakan.png" />
        <div class="info">
            <div class="name">Hakan Serdar</div>
            <div class="role">Rechtsabteilung</div>
        </div>
    </div>

    <div class="chat-item" data-person="sophie">
        <img src="Sophie.png" />
        <div class="info">
            <div class="name">Sophie Fischer</div>
            <div class="role">Personalabteilung</div>
        </div>
    </div>

    <div class="chat-item" data-person="sarah">
        <img src="Sarah.png" />
        <div class="info">
            <div class="name">Sarah Hosse</div>
            <div class="role">Verkauf</div>
        </div>
    </div>

    <div class="chat-item" data-person="timo">
        <img src="Timo.png" />
        <div class="info">
            <div class="name">Timo Jung</div>
            <div class="role">Wirtschaftsanalyse</div>
        </div>
    </div>

    <div class="chat-item" data-person="elke">
        <img src="Elke.png" />
        <div class="info">
            <div class="name">Elke Wagner</div>
            <div class="role">Empfang, Ausbildung & Schule</div>
        </div>
    </div>
</div>

<div id="chatWindow">
    <div class="chat-header">
        <span class="back-btn" id="backBtn">←</span>
        <img id="chatAvatar" src="" />
        <div><div class="name" id="chatName"></div></div>
    </div>

    <div class="desc" id="chatDescription"></div>
    <div class="messages" id="messages"></div>

    <div class="composer">
        <div class="composer-inner">
            <textarea id="input" placeholder="Nachricht eingeben..." rows="1"></textarea>
            <button id="send">Senden</button>
        </div>
    </div>
</div>

</div>

<script>
const profiles = {
    tina: { name: "Tina Müller", avatar: "Tina.png", desc: "Tina arbeitet in der Finanzabteilung und ist dir bei allen Fragestellungen rund um Finanzen behilflich." },
    christian: { name: "Christian Weber", avatar: "Christian.png", desc: "Christian arbeitet in der Marketingabteilung und ist dir bei allen Fragestellungen rund um Marketing behilflich." },
    hakan: { name: "Hakan Serdar", avatar: "Hakan.png", desc: "Hakan arbeitet in der Rechtsabteilung und ist dir bei allen rechtlichen Fragestellungen behilflich." },
    sophie: { name: "Sophie Fischer", avatar: "Sophie.png", desc: "Sophie arbeitet in der Personalabteilung und ist dir bei allen Fragestellungen rund um Personal behilflich." },
    sarah: { name: "Sarah Hosse", avatar: "Sarah.png", desc: "Sarah arbeitet im Verkauf und ist dir bei allen Fragestellungen rund um den Verkauf behilflich." },
    timo: { name: "Timo Jung", avatar: "Timo.png", desc: "Timo arbeitet als Analyst bei der CWE und ist dir bei allen volkswirtschaftlichen Fragestellungen behilflich." },
    elke: { name: "Elke Wagner", avatar: "Elke.png", desc: "Elke arbeitet am Empfang und ist dir bei allen Fragestellungen behilflich, bei denen dir sonst niemand helfen kann. Außerdem ist sie deine Ausbildungskoordinatorin und hilft dir auch bei Fragen rund um die Berufsschule weiter." }
};

const chatList = document.getElementById("chatList");
const chatWindow = document.getElementById("chatWindow");
const messagesDiv = document.getElementById("messages");
const chatDescription = document.getElementById("chatDescription");
const chatName = document.getElementById("chatName");
const chatAvatar = document.getElementById("chatAvatar");
const backBtn = document.getElementById("backBtn");
const input = document.getElementById("input");
const send = document.getElementById("send");

let currentPerson = null;
const history = { tina: [], christian: [], hakan: [], sophie: [], sarah: [], timo: [], elke: [] };

function addMessage(text, who) {
    const div = document.createElement("div");
    div.className = "msg " + who;
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function moveChatItemToTop(person) {
    const item = document.querySelector(`.chat-item[data-person="${person}"]`);
    if (item) {
        chatList.removeChild(item);
        chatList.insertBefore(item, chatList.firstChild);
    }
}

function openChat(person) {
    currentPerson = person;
    chatList.style.display = "none";
    chatWindow.style.display = "flex";
    chatName.textContent = profiles[person].name;
    chatAvatar.src = profiles[person].avatar;

    chatDescription.textContent = profiles[person].desc;
    chatDescription.style.display = "block";

    messagesDiv.innerHTML = "";
    history[person].forEach(msg => addMessage(msg.text, msg.who));

    input.value = "";
    adjustTextareaHeight();
}

/**
 * Passt die Höhe des Textareas nur dynamisch nach oben an, nicht nach unten.
 * Maximale Höhe: 140px, minimale Höhe: 40px.
 * Wenn kleiner als minHeight, wird minHeight gesetzt.
 * Wenn größer als maxHeight, overflow-y: scroll, Höhe auf maxHeight, sonst passt Höhe an scrollHeight an.
 */
function adjustTextareaHeight() {
    input.style.height = "auto"; // height zurücksetzen, um scrollHeight richtig zu messen
    const minHeight = 40;
    const maxHeight = 140;
    const scrollHeight = input.scrollHeight;

    if (scrollHeight < minHeight) {
        input.style.height = minHeight + "px";
        input.style.overflowY = "hidden";
    } else if (scrollHeight > maxHeight) {
        input.style.height = maxHeight + "px";
        input.style.overflowY = "scroll";
    } else {
        input.style.height = scrollHeight + "px";
        input.style.overflowY = "hidden";
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/**
 * Gibt zurück, ob das Gerät ein Touchgerät (Smartphone) ist.
 */
function isTouchDevice() {
    return (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
}

document.querySelectorAll(".chat-item").forEach(item => {
    item.addEventListener("click", () => openChat(item.dataset.person));
});

// Keydown für Eingabetaste unterscheidet PC/Mac vs Smartphone
input.addEventListener("keydown", e => {
    if (isTouchDevice()) {
        // Auf Touchgerät: Enter fügt immer neue Zeile ein
        // Kein Senden über Enter
        // Keine Aktion nötig hier, Standardverhalten belassen
        return;
    } else {
        // Auf PC/Mac:
        if (e.key === "Enter") {
            if (e.shiftKey) {
                // Shift+Enter: Neue Zeile einfügen, Standardverhalten erlaubt
                return;
            } else {
                // Enter ohne Shift: Nachricht senden
                e.preventDefault();
                sendMessage();
            }
        }
    }
});

input.addEventListener("input", () => adjustTextareaHeight());

async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    history[currentPerson].push({ text, who: "user" });

    input.value = "";
    adjustTextareaHeight();

    if (chatDescription.style.display !== "none") {
        chatDescription.style.display = "none";
    }

    const messagesForApi = history[currentPerson].map(m => ({
        role: m.who === "user" ? "user" : "assistant",
        content: m.text
    }));

    try {
        const resp = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person: currentPerson, messages: messagesForApi })
        });

        const data = await resp.json();
        const answer = data.message?.content ?? "Fehler.";
        addMessage(answer, "bot");
        history[currentPerson].push({ text: answer, who: "bot" });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

    } catch (error) {
        addMessage("Beim Senden der Nachricht ist ein Fehler aufgetreten.", "bot");
    }
}

// Sendebutton sendet die Nachricht
send.addEventListener("click", sendMessage);

backBtn.addEventListener("click", () => {
    chatWindow.style.display = "none";
    chatList.style.display = "block";
});
</script>

</body>
</html>
